<!--
  This component displays customer details and a payment processing form.
  It is a full rewrite of the provided HTML, focusing on:
  - Better semantic structure using <section> and <form>.
  - Enhanced accessibility with proper <label> and <input> associations.
  - Improved user experience with form validation and button states.
  - Cleaner hover effects using CSS instead of component methods.
  - Overall improved readability and code organization.
-->
<div class="p-4 mx-auto max-w-7xl rounded-xl shadow-2xl border transition-all duration-500 ease-in-out"
  [style.backgroundColor]="'var(--theme-bg-main)'"
  [style.borderColor]="'var(--theme-border-secondary)'"
  [style.color]="'var(--theme-text-primary)'">

  <!-- Header Section with Customer Select and Main Title -->
  <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
    <!-- Main Heading -->
    <h1 class="text-3xl font-bold text-center md:text-left flex-1"
      [style.color]="'var(--theme-text-heading)'">
      Customer Payment
    </h1>

    <!-- Customer Select Dropdown -->
    <div class="w-full md:w-80">
      <p-select [(ngModel)]="customerId"
        (onChange)="fetchCustomerData()"
        [options]="customerIDDropdown"
        optionLabel="fullname"
        optionValue="_id"
        placeholder="Select Customer"
        class="w-full">
      </p-select>
    </div>
  </header>

  <div class="flex flex-col md:flex-row gap-8">
    <!-- Customer Details Section -->
    <section class="flex-1 p-4 rounded-lg shadow-md"
      [style.backgroundColor]="'var(--theme-bg-secondary)'">
      <h2 class="text-xl font-semibold mb-4" [style.color]="'var(--theme-text-heading)'">Customer Information</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Replaced onDetailBoxHover with a custom class for cleaner CSS hover effects -->
        <div class="detail-box" [style.backgroundColor]="'var(--theme-bg-tertiary)'" [style.borderColor]="'var(--theme-border-secondary)'">
          <dt class="font-semibold" [style.color]="'var(--theme-text-label)'">Name</dt>
          <dd class="text-lg font-medium" [style.color]="'var(--theme-text-primary)'">{{ customer?.fullname || '-' }}</dd>
        </div>
        <div class="detail-box" [style.backgroundColor]="'var(--theme-bg-tertiary)'" [style.borderColor]="'var(--theme-border-secondary)'">
          <dt class="font-semibold" [style.color]="'var(--theme-text-label)'">Email</dt>
          <dd class="text-lg font-medium" [style.color]="'var(--theme-text-primary)'">{{ customer?.email || '-' }}</dd>
        </div>
        <div class="detail-box" [style.backgroundColor]="'var(--theme-bg-tertiary)'" [style.borderColor]="'var(--theme-border-secondary)'">
          <dt class="font-semibold" [style.color]="'var(--theme-text-label)'">Phone Number</dt>
          <dd class="text-lg font-medium" [style.color]="'var(--theme-text-primary)'">
            {{ customer?.phoneNumbers?.[0]?.number || '-' }}
            (<span [style.color]="'var(--theme-text-secondary)'">{{ customer?.phoneNumbers?.[0]?.type || '-' }}</span>)
          </dd>
        </div>
        <div class="detail-box" [style.backgroundColor]="'var(--theme-bg-tertiary)'" [style.borderColor]="'var(--theme-border-secondary)'">
          <dt class="font-semibold" [style.color]="'var(--theme-text-label)'">Status</dt>
          <dd class="text-lg font-medium" [ngClass]="{'text-[var(--theme-success-primary)]': customer?.status === 'active', 'text-[var(--theme-error-primary)]': customer?.status !== 'active'}">
            {{ customer?.status || '-' }}
          </dd>
        </div>
        <div class="detail-box" [style.backgroundColor]="'var(--theme-bg-tertiary)'" [style.borderColor]="'var(--theme-border-secondary)'">
          <dt class="font-semibold" [style.color]="'var(--theme-text-label)'">Total Purchased Amount</dt>
          <dd class="font-bold text-xl" [style.color]="'var(--theme-success-primary)'">₹{{ customer?.totalPurchasedAmount || '0' }}</dd>
        </div>
        <div class="detail-box" [style.backgroundColor]="'var(--theme-bg-tertiary)'" [style.borderColor]="'var(--theme-border-secondary)'">
          <dt class="font-semibold" [style.color]="'var(--theme-text-label)'">Remaining Amount</dt>
          <dd class="font-bold text-xl" [style.color]="'var(--theme-error-primary)'">₹{{ customer?.remainingAmount || '0' }}</dd>
        </div>
        <div class="detail-box md:col-span-2" [style.backgroundColor]="'var(--theme-bg-tertiary)'" [style.borderColor]="'var(--theme-border-secondary)'">
          <dt class="font-semibold" [style.color]="'var(--theme-text-label)'">Address</dt>
          <dd class="text-lg font-medium" [style.color]="'var(--theme-text-primary)'">
            {{ customer?.addresses?.[0]?.street || '-' }},
            {{ customer?.addresses?.[0]?.city || '-' }},
            {{ customer?.addresses?.[0]?.state || '-' }},
            {{ customer?.addresses?.[0]?.zipCode || '-' }}
          </dd>
        </div>
        <div class="detail-box md:col-span-2" [style.backgroundColor]="'var(--theme-bg-tertiary)'" [style.borderColor]="'var(--theme-border-secondary)'">
          <dt class="font-semibold" [style.color]="'var(--theme-text-label)'">Guarantor ID</dt>
          <dd class="text-lg font-medium" [style.color]="'var(--theme-text-primary)'">{{ customer?.guaranteerId || '-' }}</dd>
        </div>
      </div>
    </section>

    <!-- Process Payment Section -->
    <section class="flex-1 p-4 rounded-lg shadow-md"
      [style.backgroundColor]="'var(--theme-bg-secondary)'">
      <h2 class="text-2xl font-semibold mb-6 text-center" [style.color]="'var(--theme-text-heading)'">Process Payment</h2>
      <!-- Wrapped payment inputs in a <form> for better handling -->
      <form (ngSubmit)="onSubmit()">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Amount Input -->
          <div>
            <label for="amount-input" class="block text-sm font-bold mb-2" [style.color]="'var(--theme-text-label)'">Amount <span class="text-red-500">*</span></label>
            <input id="amount-input" type="number" [(ngModel)]="paymentData.amount" name="amount"
              class="form-input shadow-sm appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              [style.backgroundColor]="'var(--theme-bg-tertiary)'"
              [style.borderColor]="'var(--theme-border-secondary)'"
              [style.color]="'var(--theme-text-primary)'"
              placeholder="Enter amount" min="0" required>
          </div>

          <!-- Payment Method Select -->
          <div>
            <label for="payment-method-select" class="block text-sm font-bold mb-2" [style.color]="'var(--theme-text-label)'">Payment Method <span class="text-red-500">*</span></label>
            <select id="payment-method-select" [(ngModel)]="paymentData.paymentMethod" name="paymentMethod"
              class="form-select shadow-sm appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              [style.backgroundColor]="'var(--theme-bg-tertiary)'"
              [style.borderColor]="'var(--theme-border-secondary)'"
              [style.color]="'var(--theme-text-primary)'" required>
              <option *ngFor="let method of paymentMethods" [value]="method">{{ method }}</option>
            </select>
          </div>

          <!-- Payment Status Select -->
          <div>
            <label for="payment-status-select" class="block text-sm font-bold mb-2" [style.color]="'var(--theme-text-label)'">Payment Status <span class="text-red-500">*</span></label>
            <select id="payment-status-select" [(ngModel)]="paymentData.status" name="status"
              class="form-select shadow-sm appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              [style.backgroundColor]="'var(--theme-bg-tertiary)'"
              [style.borderColor]="'var(--theme-border-secondary)'"
              [style.color]="'var(--theme-text-primary)'" required>
              <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
            </select>
          </div>

          <!-- Description Textarea -->
          <div class="md:col-span-3">
            <label for="description-textarea" class="block text-sm font-bold mb-2" [style.color]="'var(--theme-text-label)'">Description</label>
            <textarea id="description-textarea" [(ngModel)]="paymentData.description" name="description" rows="2"
              class="form-textarea shadow-sm appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              [style.backgroundColor]="'var(--theme-bg-tertiary)'"
              [style.borderColor]="'var(--theme-border-secondary)'"
              [style.color]="'var(--theme-text-primary)'"
              placeholder="Payment description (max 200 characters)" maxlength="200"></textarea>
          </div>

          <!-- Metadata Textarea -->
          <div class="md:col-span-3">
            <label for="metadata-textarea" class="block text-sm font-bold mb-2" [style.color]="'var(--theme-text-label)'">Metadata (JSON)</label>
            <textarea id="metadata-textarea" [(ngModel)]="paymentData.metadata" name="metadata" rows="3"
              class="form-textarea shadow-sm appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              [style.backgroundColor]="'var(--theme-bg-tertiary)'"
              [style.borderColor]="'var(--theme-border-secondary)'"
              [style.color]="'var(--theme-text-primary)'"
              placeholder='Optional metadata in JSON format (e.g., {"invoice_id": "123"})'></textarea>
            <p *ngIf="paymentData.metadata && !isValidJson(paymentData.metadata)" class="text-sm mt-1" [style.color]="'var(--theme-text-error)'">
              Invalid JSON format
            </p>
          </div>

          <!-- Process Payment Button -->
          <div class="md:col-span-3 mt-2">
            <button type="submit"
              class="w-full font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
              [style.background]="'var(--theme-button-bg-primary)'"
              [style.color]="'var(--theme-button-text-primary-btn)'"
              [disabled]="!customerId || !paymentData.amount || !isValidJson(paymentData.metadata)">
              Process Payment
            </button>
          </div>
        </div>
      </form>
    </section>
  </div>
</div>
