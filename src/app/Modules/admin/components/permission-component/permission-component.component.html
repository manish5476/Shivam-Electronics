<div class="permission-container p-4">
  <p-toast position="top-right"></p-toast>

  <!-- Header -->
  <div class="mb-4">
    <h1 class="text-2xl font-semibold text-slate-800 flex items-center gap-2">
      <i class="pi pi-lock text-blue-600 text-lg"></i>
      Manage User Permissions
    </h1>
    <p class="text-sm text-slate-500">
      Click a user card to expand and manage their API route access.
    </p>
  </div>

  <!-- Users Grid -->
  <div *ngIf="!isLoading && !error; else loadingOrError" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
    <div *ngFor="let user of users"
      class="user-card relative bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-lg transition-all overflow-hidden">

      <!-- Card Header -->
      <div class="flex items-center justify-between p-4 cursor-pointer" (click)="user.expanded = !user.expanded">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-full flex items-center justify-center text-white font-semibold"
            [style.background]="user.color">
            {{ getInitials(user.name) }}
          </div>
          <div flex>
            <p class="font-medium text-slate-800">{{ user.name }}</p>
            <p class="text-xs text-slate-500">{{ user.email }}</p>
          </div>
        </div>
        <!-- <p-inputSwitch [(ngModel)]="user.allPermissionsEnabled"
              (onChange)="onToggleAllPermissions(user)"></p-inputSwitch>
        <div class="flex items-center gap-2">
          <p-tag [value]="user.role" [severity]="getRoleSeverity(user.role)"></p-tag>
          <i class="pi"
            [ngClass]="user.expanded ? 'pi-chevron-up text-blue-600' : 'pi-chevron-down text-slate-400'"></i>
        </div> -->
        <div class="flex items-center gap-3" (click)="$event.stopPropagation()">
          <!-- Enable All Toggle -->
          <div class="flex items-center gap-1 text-xs text-slate-600">
            <span>All</span>
            <p-inputSwitch [(ngModel)]="user.allPermissionsEnabled"
              (onChange)="onToggleAllPermissions(user)"></p-inputSwitch>
          </div>

          <!-- Role Tag -->
          <p-tag [value]="user.role" [severity]="getRoleSeverity(user.role)" styleClass="capitalize"
            (click)="$event.stopPropagation()"></p-tag>

          <!-- Chevron -->
          <i class="pi transition-transform duration-300"
            (click)="user.expanded = !user.expanded; $event.stopPropagation()" [ngClass]="
      user.expanded
        ? 'pi-chevron-up text-blue-600 rotate-180'
        : 'pi-chevron-down text-slate-400'"></i>
        </div>

      </div>

      <!-- Expanded Permissions -->
      <div class="transition-all duration-300" [style.maxHeight]="user.expanded ? '50vh' : '0px'"
        [style.opacity]="user.expanded ? '1' : '0'" [style.overflow]="user.expanded ? 'auto' : 'hidden'">

        <div class="p-4 border-t border-slate-100 bg-slate-50">
          <div *ngFor="let group of permissionGroups" class="mb-4">
            <p class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <i class="pi pi-folder text-slate-400 text-xs"></i>
              {{ group.name }}
            </p>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <div *ngFor="let p of group.permissions"
                class="flex items-center justify-between bg-white rounded-lg px-3 py-2 border border-slate-200 hover:bg-slate-100 transition">
                <span class="text-sm text-slate-700">{{ p.description }}</span>
                <p-inputSwitch [(ngModel)]="user.permissionMap[p.tag]" [disabled]="user.role !== 'user'"
                  (onChange)="onPermissionChange(user)">
                </p-inputSwitch>
              </div>
            </div>
          </div>
        </div>

        <!-- Save Bar -->
        <div class="sticky bottom-0 bg-white border-t border-slate-200 p-3 flex justify-end">
          <p-button *ngIf="user.role === 'user'; else fullAccess"
            label="{{ savingState[user._id] ? 'Saving...' : 'Save Changes' }}" icon="pi pi-check"
            [loading]="savingState[user._id]" [disabled]="!user.isDirty" size="small" styleClass="p-button-sm"
            (click)="onSavePermissions(user)">
          </p-button>
          <ng-template #fullAccess>
            <p-tag value="Full Access" icon="pi pi-lock" severity="success"></p-tag>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading/Error -->
  <ng-template #loadingOrError>
    <div *ngIf="isLoading" class="flex flex-col items-center justify-center py-10">
      <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
      <p class="mt-3 text-sm text-slate-600">Loading users & permissions...</p>
    </div>

    <div *ngIf="error && !isLoading" class="flex flex-col items-center justify-center py-10">
      <i class="pi pi-exclamation-triangle text-red-500 text-2xl mb-3"></i>
      <p class="font-semibold text-red-700">{{ error }}</p>
    </div>
  </ng-template>
</div>