<main class="flex-1 p-8 overflow-y-auto">
  <h1 class="text-3xl font-bold text-gray-800 mb-8">Customer Overview</h1>
  <div class="card p-6 bg-white rounded-lg shadow-md">
    <p-toast />
    <h2 class="text-xl font-semibold text-gray-800 mb-5">Customer Overview</h2>

    <div class="mb-4 flex items-center gap-2 md:gap-3">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input pInputText type="text" [(ngModel)]="searchTerm" (input)="filterCustomers()"
          placeholder="Search customers..." class="w-40 sm:w-48 md:w-56 text-sm p-inputtext-sm">
      </span>

      <p-button label="Expand All" icon="pi pi-plus" text (onClick)="expandAll()"
        class="p-button-sm p-button-text"></p-button>
      <p-button label="Collapse All" icon="pi pi-minus" text (onClick)="collapseAll()"
        class="p-button-sm p-button-text"></p-button>
    </div>

    <p-table [value]="filteredCustomers" dataKey="_id" [tableStyle]="{ 'min-width': '60rem' }"
      [expandedRowKeys]="expandedRows" (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5rem; background-color: #3B82F6; color: white; padding: 0.75rem 1rem;"></th>
          <th pSortableColumn="fullname" style="background-color: #3B82F6; color: white; padding: 0.75rem 1rem;">Full
            Name <p-sortIcon field="fullname" /></th>
          <th pSortableColumn="email" style="background-color: #3B82F6; color: white; padding: 0.75rem 1rem;">
            Email <p-sortIcon field="email" /></th>
          <th pSortableColumn="totalPurchasedAmount"
            style="background-color: #3B82F6; color: white; padding: 0.75rem 1rem;">Total Purchased
            <p-sortIcon field="totalPurchasedAmount" />
          </th>
          <th pSortableColumn="remainingAmount" style="background-color: #3B82F6; color: white; padding: 0.75rem 1rem;">
            Remaining Amount
            <p-sortIcon field="remainingAmount" />
          </th>
          <th pSortableColumn="status" style="background-color: #3B82F6; color: white; padding: 0.75rem 1rem;">Status
            <p-sortIcon field="status" />
          </th>

        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-customer let-expanded="expanded">
        <tr>
          <td><p-button type="button" pRipple [pRowToggler]="customer" [text]="true" [rounded]="true" [plain]="true"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" /> </td>
          <td>{{ customer.fullname }}</td>
          <td>{{ customer.email }}</td>
          <td>{{ customer.totalPurchasedAmount | currency : 'INR' : 'symbol' : '1.2-2' }}</td>
          <td>{{ customer.remainingAmount | currency : 'INR' : 'symbol' : '1.2-2' }}</td>
          <td><p-tag [value]="customer.remainingAmount === 0 ? 'Paid' : 'Unpaid'"
              [severity]="CommonMethodService.getSeverity(customer.remainingAmount === 0 ? 'Paid' : 'Unpaid')" />
          </td>

        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center">No customers found.</td>
        </tr>
      </ng-template>
      <ng-template pTemplate="expandedrow" let-customer>
        <tr>
          <td colspan="7">
            <div class="p-4 border-gray-100">
              <h5 class="text-lg font-medium text-gray-800 mb-3">Products Purchased by {{ customer.fullname }}</h5>
              <p-table [value]="customer.cart.items" dataKey="productId._id" [tableStyle]="{ 'min-width': '50rem' }"
                [expandedRowKeys]="expandedProductRows" (onRowExpand)="onProductRowExpand($event)"
                (onRowCollapse)="onProductRowCollapse($event)"> <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem; background-color: #60A5FA; color: white; padding: 0.5rem 0.75rem;"></th>
          <th pSortableColumn="productId.title" style="background-color: #60A5FA; color: white; padding: 0.5rem 0.75rem;">Product Name <p-sortIcon field="productId.title" /></th>
          <th pSortableColumn="productId.price" style="background-color: #60A5FA; color: white; padding: 0.5rem 0.75rem;">Price <p-sortIcon field="productId.price" /></th>
          <th style="background-color: #60A5FA; color: white; padding: 0.5rem 0.75rem;">Thumbnail</th>
          <th pSortableColumn="invoiceIds.length"  style="background-color: #60A5FA; color: white; padding: 0.5rem 0.75rem;">Invoices Count  <p-sortIcon field="invoiceIds.length" /> </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-cartItem let-expanded="expanded">
        <tr>
          <td> <p-button type="button" pRipple [pRowToggler]="cartItem" [text]="true" [rounded]="true" [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" /> </td>
          <td>{{ cartItem.productId.title }}</td>
          <td>{{ cartItem.productId.price | currency : 'INR' : 'symbol' : '1.2-2' }}</td>
          <td> <img [src]="cartItem.productId.thumbnail" [alt]="cartItem.productId.title" width="50"class="shadow-md rounded-md" /> </td>
          <td>{{ cartItem.invoiceIds.length }}</td>
        </tr>
      </ng-template>

      <!--  -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center">No products found in cart.</td>
        </tr>
      </ng-template>
      <ng-template pTemplate="expandedrow" let-cartItem>
        <tr>
          <td colspan="5">
            <div class="p-4 border-gray-100">
              <h6 class="text-md font-medium text-gray-700 mb-3">Invoices for {{ cartItem.productId.title }} </h6>
              <p-table [value]="cartItem.invoiceIds" dataKey="_id" [tableStyle]="{ 'min-width': '40rem' }"> <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="invoiceNumber" style="background-color: #93C5FD; color: #1E3A8A; padding: 0.5rem 0.75rem;">Invoice No. <p-sortIcon field="invoiceNumber" />  </th>
          <th pSortableColumn="invoiceDate" style="background-color: #93C5FD; color: #1E3A8A; padding: 0.5rem 0.75rem;"> Date <p-sortIcon field="invoiceDate" /></th>
          <th pSortableColumn="totalAmount" style="background-color: #93C5FD; color: #1E3A8A; padding: 0.5rem 0.75rem;"> Amount <p-sortIcon field="totalAmount" /></th>
          <th pSortableColumn="status" style="background-color: #93C5FD; color: #1E3A8A; padding: 0.5rem 0.75rem;"> Status <p-sortIcon field="status" /></th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-invoice>
        <tr>
          <td>{{ invoice.invoiceNumber }}</td>
          <td>{{ invoice.invoiceDate | date:'mediumDate' }}</td>
          <td>{{ invoice.totalAmount | currency : 'INR' : 'symbol' : '1.2-2' }}</td>
          <td> <p-tag [value]="invoice.status" [severity]="CommonMethodService.getInvoiceStatusSeverity(invoice.status)" /> </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr> <td colspan="4" class="text-center">No invoices for this product.</td> </tr>
      </ng-template>
    </p-table>
  </div>
  </td>
  </tr>
  </ng-template>
  </p-table>

  <h5 class="text-lg font-medium text-gray-800 mt-6 mb-3">Payment History for {{ customer.fullname }}</h5>
  <p-table [value]="customer.paymentHistory" dataKey="_id" [tableStyle]="{ 'min-width': '40rem' }">
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="transactionId" style="background-color: #3B82F6; color: white; padding: 0.75rem 1rem;">
          Transaction ID <p-sortIcon field="transactionId" /></th>
        <th pSortableColumn="amount" style="background-color: #3B82F6; color: white; padding: 0.75rem 1rem;">
          Amount <p-sortIcon field="amount" /></th>
        <th pSortableColumn="status" style="background-color: #3B82F6; color: white; padding: 0.75rem 1rem;">
          Status <p-sortIcon field="status" /></th>
        <th pSortableColumn="createdAt" style="background-color: #3B82F6; color: white; padding: 0.75rem 1rem;">Date
          <p-sortIcon field="createdAt" />
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-payment>
      <tr>
        <td>{{ payment.transactionId }}</td>
        <td>{{ payment.amount | currency : 'INR' : 'symbol' : '1.2-2' }}</td>
        <td>
          <p-tag [value]="payment.status" [severity]="CommonMethodService.getPaymentStatusSeverity(payment.status)" />
        </td>
        <td>{{ payment.createdAt | date:'medium' }}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="4" class="text-center">No payment history found.</td>
      </tr>
    </ng-template>
  </p-table>
  </div>
  </td>
  </tr>
  </ng-template>
  </p-table>
  </div>
</main>