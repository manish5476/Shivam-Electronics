<div class="customer-dashboard-container" *ngIf="data">

  <!-- KPIs -->
  <div class="customer-kpi-grid">
    <div class="customer-kpi-card">
      <div class="customer-kpi-icon"><i class="pi pi-user-plus"></i></div>
      <div>
        <p class="customer-kpi-title">New Customers</p>
        <p class="customer-kpi-value">{{ data.summary.newCustomers }}</p>
      </div>
    </div>
    <div class="customer-kpi-card">
      <div class="customer-kpi-icon"><i class="pi pi-refresh"></i></div>
      <div>
        <p class="customer-kpi-title">Repeat Customer Rate</p>
        <p class="customer-kpi-value">{{ data.summary.repeatCustomerRate | percent }}</p>
      </div>
    </div>
    <div class="customer-kpi-card">
      <div class="customer-kpi-icon"><i class="pi pi-dollar"></i></div>
      <div>
        <p class="customer-kpi-title">Returning Revenue</p>
        <p class="customer-kpi-value">{{ data.revenueBreakdown[0]?.totalRevenue | currency }}</p>
      </div>
    </div>
  </div>

  <!-- Dashboard Grid -->
  <div class="customer-dashboard-grid">

    <!-- Top Customers List -->
    <div class="customer-list-card">
      <h3 class="section-title"><i class="pi pi-users"></i> Top Customers Lifetime</h3>
      <div class="customer-list-wrapper">
        <div class="customer-card-header" *ngFor="let customer of data.topCustomersLifetime">
          <img [src]="customer.profileImage || 'assets/default-profile.png'" alt="{{customer.fullname}}"
            class="customer-profile-image" />
          <div class="customer-info">
            <span class="customer-name">{{ customer.fullname }}</span>
            <span class="customer-email">{{ customer.email }}</span>
            <span class="customer-total-purchase">Total Purchase: {{ customer.totalPurchasedAmount | currency }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Side / At Risk Customers -->
    <div class="customer-side-grid">
      <div class="customer-side-card" *ngIf="data.atRiskCustomers.length > 0">
        <h3><i class="pi pi-exclamation-triangle"></i> At Risk Customers</h3>
        <ul>
          <li *ngFor="let customer of data.atRiskCustomers">{{ customer.fullname }}</li>
        </ul>
      </div>
      <!-- Placeholder / Additional Cards -->
      <div class="customer-side-card">
        <h3><i class="pi pi-chart-line"></i> Additional Metrics</h3>
        <p>Use this area for other customer insights, like churn rate, lifetime value, etc.</p>
      </div>
    </div>

  </div>

</div>


<!-- <div class="top-customers-container">
  <p-toast />
  <div class="table-header">
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input pInputText type="text" [(ngModel)]="searchTerm" (input)="filterCustomers()" name="searchterm"
        placeholder="Search customers..." class="p-inputtext-sm" />
    </span>
    <div class="flex items-center gap-2">
      <button pButton pRipple type="button" label="Expand All" icon="pi pi-plus" class="p-button-text p-button-sm"
        (click)="expandAll()"></button>
      <button pButton pRipple type="button" label="Collapse All" icon="pi pi-minus" class="p-button-text p-button-sm"
        (click)="collapseAll()"></button>
    </div>
  </div>

  <p-table [value]="filteredCustomers" dataKey="_id" [tableStyle]="{'min-width': '50rem'}"
    [expandedRowKeys]="expandedRows" styleClass="p-datatable-customers">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 5rem;"></th>
        <th>Customer</th>
        <th>Total Purchased (Period)</th>
        <th>Total Purchased (All Time)</th>
        <th style="width: 6rem;">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-customer let-expanded="expanded">
      <tr class="main-row">
        <td>
          <button pButton pRipple type="button" [pRowToggler]="customer"
            class="p-button-text p-button-rounded p-button-plain"
            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
          </button>
        </td>

        <td>
          <div class="customer-cell">
            <p-avatar [label]="CommonMethodService.getInitials(customer.fullname)"
              [style]="{'background-color': CommonMethodService.generateHexColorFromString(customer.fullname), 'color': '#ffffff'}"
              shape="circle">
            </p-avatar>
            <div>
              <div class="font-bold text-[var(--theme-text-primary)]">{{ customer.fullname }}</div>
              <div class="text-sm text-[var(--theme-text-secondary)]">{{ customer.email }}</div>
            </div>
          </div>
        </td>
        <td class="text-[var(--theme-text-secondary)]">{{
          CommonMethodService.formatCurrency(customer.periodPurchasedAmount) }}</td>
        <td class="font-semibold text-[var(--theme-text-primary)]">{{
          CommonMethodService.formatCurrency(customer.totalPurchasedAmountGlobal) }}</td>
        <td><button pButton pRipple type="button" icon="pi pi-user-edit"
            class="p-button-text p-button-rounded"></button></td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center py-4 text-[var(--theme-text-secondary)]">No customers found.</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="expandedrow" let-customer>
      <tr>
        <td colspan="5">
          <div class="expanded-content">
            <h5 class="expanded-header">Products Purchased by {{ customer.fullname }}</h5>
            <p-table [value]="customer.cart?.items" dataKey="productId._id"
              styleClass="p-datatable-sm p-datatable-nested">
              <ng-template pTemplate="header">
      <tr>
        <th>Product Name</th>
        <th>Price</th>
        <th>Invoices</th>
        <th style="width: 6rem;">View</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-cartItem>
      <tr class="nested-row">
        <td>{{ cartItem.productId?.title || 'N/A' }}</td>
        <td>{{ CommonMethodService.formatCurrency(cartItem.productId?.price) }}</td>
        <td>{{ cartItem.invoiceIds?.length || 0 }}</td>
        <td>
          <button pButton pRipple type="button" icon="pi pi-file-pdf" class="p-button-text p-button-sm"
            (click)="showInvoicePdf(cartItem.invoiceIds[0])"></button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="4" class="text-center py-3 text-sm text-[var(--theme-text-secondary)]">No products found for this
          period.</td>
      </tr>
    </ng-template>
  </p-table>
</div>
</td>
</tr>
</ng-template>
</p-table>
</div>

<p-dialog header="Invoice" [modal]="true" [(visible)]="showpdf" [style]="{ width: '95vw', maxWidth: '1200px' }">
  <app-invoice-print [Id]="invoiceId"></app-invoice-print>
</p-dialog> -->