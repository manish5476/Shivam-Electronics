<p-toast position="top-right"></p-toast>
<div class="admin-dashboard min-h-screen p-6" [style]="{'background': 'var(--theme-bg-primary)'}" [@fadeIn]="true">
  <p-toolbar styleClass="sticky top-0 z-20 shadow-lg rounded-xl mb-6 se-filter-bar" [style]="{'background': 'var(--theme-bg-secondary)'}">
    <div class="p-toolbar-group-left">
      <h2 class="text-2xl font-bold tracking-tight" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Admin Dashboard</h2>
    </div>
    <div class="p-toolbar-group-center flex flex-wrap gap-4 items-center">
      <p-select [options]="periodOptions" [(ngModel)]="selectedPeriod" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-48 rounded-xl" [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" (onChange)="onFilterChange()"></p-select>
      <p-select [options]="limitOptions" [(ngModel)]="dataLimit" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-36 rounded-xl" [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" (onChange)="onFilterChange()"></p-select>
      <div *ngIf="selectedPeriod === 'custom'" class="flex gap-3 items-center">
        <p-calendar [(ngModel)]="customDateRange" selectionMode="range" [readonlyInput]="true"
          placeholder="Select Date Range" dateFormat="dd/mm/yy"
          styleClass="p-inputtext-sm w-72 rounded-xl" [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" ></p-calendar>
        <button pButton type="button" label="Apply" icon="pi pi-check" class="p-button-sm rounded-xl"
          [style]="{'background': 'var(--theme-accent-primary)', 'color': 'var(--theme-accent-text-color)', 'border': 'none'}" (click)="onApplyCustomRange()"></button>
      </div>
      <p-progressSpinner *ngIf="isLoading" styleClass="w-6 h-6" strokeWidth="4"></p-progressSpinner>
    </div>
    <div class="p-toolbar-group-right flex gap-3">
      <button pButton pRipple type="button" [icon]="isGridLocked ? 'pi pi-lock' : 'pi pi-lock-open'"
        [label]="isGridLocked ? 'Unlock Grid' : 'Lock Grid'" class="p-button-outlined p-button-sm rounded-xl"
        [style]="{'border-color': 'var(--theme-border-primary)', 'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}" (click)="toggleLockGrid()"></button>
      <button pButton type="button" icon="pi pi-save" label="Save Layout" class="p-button-sm rounded-xl"
        [style]="{'background': 'var(--theme-accent-primary)', 'color': 'var(--theme-accent-text-color)', 'border': 'none', 'font-family': 'var(--font-body)'}" (click)="saveLayout()"></button>
      <button pButton type="button" icon="pi pi-refresh" label="Reload All" class="p-button-sm rounded-xl"
        [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" (click)="triggerRefresh()"></button>
      <button pButton type="button" icon="pi pi-code" label="Toggle JSON" class="p-button-sm p-button-outlined rounded-xl"
        [style]="{'border-color': 'var(--theme-border-primary)', 'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}" (click)="showJson = !showJson"></button>
    </div>
  </p-toolbar>

  <p-panel *ngIf="showJson" header="Dashboard Data (Debug)" styleClass="mb-6 shadow-lg rounded-xl"
    [style]="{'background': 'var(--theme-bg-secondary)'}">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center w-full px-4 py-2">
        <span class="text-xl font-semibold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Dashboard Data (Debug)</span>
      </div>
    </ng-template>
    <pre class="p-4 rounded-xl font-mono text-sm overflow-auto"
      [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-secondary)'}">
      {{ { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales } | json }}
    </pre>
  </p-panel>

  <div *ngIf="isLoading" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <p-skeleton width="100%" height="12rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
  </div>

  <gridstack [options]="gridOptions" *ngIf="!isLoading" class="relative">
    <gridstack-item *ngFor="let widget of widgets; trackBy: identify" [options]="widget">
      <p-panel [header]="widget.content ?? 'Unknown Widget'"
        styleClass="h-full shadow-lg rounded-xl hover:shadow-xl transition-shadow duration-300"
        [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}" [@panelAnimation]>
        <ng-template pTemplate="header">
          <div class="flex justify-between items-center w-full px-4 py-2">
            <span class="text-xl font-semibold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ widget.content ?? 'Unknown Widget' }}</span>
            <div class="flex gap-2">
              <button pButton icon="pi pi-refresh" class="p-button-text p-button-sm"
                [style]="{'color': 'var(--theme-text-secondary)'}" (click)="refreshWidget(widget.id ?? '')"></button>
              <button pButton icon="pi pi-window-maximize" class="p-button-text p-button-sm"
                [style]="{'color': 'var(--theme-text-secondary)'}" (click)="openDialog(widget.content ?? 'Unknown Widget', { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales })"></button>
            </div>
          </div>
        </ng-template>
        <p-message *ngIf="widget.id && error[widget.id]" severity="error" class="mb-4 rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>

        <!-- KPI Summary Widget -->
        <ng-container *ngIf="widget.id === 'kpiSummary' && !error['kpiSummary']">
          <div class="p-6 space-y-6" *ngIf="!isKpiLoading; else kpiLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Revenue</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Change: {{ enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Gross Profit</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Margin: {{ kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Sales</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Avg. Order: ${{ kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">LTV: ${{ enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Trend</h3>
              <ngx-charts-line-chart [results]="revenueTrendData" [view]="[600, revenueTrendData.length * 50 || 200]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Selling Products</h3>
              <p-table [value]="overview?.topSellingProducts" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Quantity</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.productName }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.totalQuantity }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
          <ng-template #kpiLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Charts Overview Widget -->
        <ng-container *ngIf="widget.id === 'chartsOverview' && !error['chartsOverview']">
          <div class="p-6" *ngIf="!isChartsLoading; else chartsLoading">
            <p-message severity="info" text="Charts data not yet available. Please provide API response data." class="rounded-xl"
              [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
          </div>
          <ng-template #chartsLoading>
            <div class="p-6">
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Product Analytics Widget -->
        <ng-container *ngIf="widget.id === 'productAnalytics' && !error['productAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isProductLoading; else productLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Inventory Value</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Items in Stock</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Low Stock</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Performance by Category</h3>
              <ngx-charts-bar-vertical [results]="categoryData" [view]="[600, categoryData.length * 60 || 300]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-bar-vertical>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Products by Revenue</h3>
              <p-table [value]="productAnalytics?.topPerformingProducts?.topByRevenue" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Brand</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Profit</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.title }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.brand }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.grossProfit?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Inventory Turnover</h3>
              <p-message severity="info" text="Inventory turnover data not yet available. Please provide API response data." class="rounded-xl"
                [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
            </div>
          </div>
          <ng-template #productLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl mb-6"></p-skeleton>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Customer Analytics Widget -->
        <ng-container *ngIf="widget.id === 'customerAnalytics' && !error['customerAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isCustomerLoading; else customerLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ customerAnalytics?.summary?.newCustomers || 0 }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Repeat Customer Rate</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Retention rate</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Customers by Lifetime Value</h3>
              <p-table [value]="customerAnalytics?.topCustomersLifetime" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Name</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Email</th>
                    <th class="text-right p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Lifetime Value</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-customer>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-3 font-medium" [style]="{'font-family': 'var(--font-body)'}">{{ customer.fullname }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ customer.email }}</td>
                    <td class="p-3 text-right" [style]="{'font-family': 'var(--font-body)'}">${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="3" class="text-center py-4" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">No customer data available</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Breakdown</h3>
              <p-message *ngIf="!customerAnalytics?.revenueBreakdown?.length" severity="info"
                text="Revenue breakdown data not available for this period." class="rounded-xl"
                [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
            </div>
          </div>
          <ng-template #customerLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="18rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Payment Analytics Widget -->
        <ng-container *ngIf="widget.id === 'paymentAnalytics' && !error['paymentAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isPaymentLoading; else paymentLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Billed</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Collected</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Collections</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Collection Rate</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Success rate</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Status</h3>
              <div class="flex items-center gap-4">
                <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
                  <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Payments</p>
                  <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ paymentAnalytics?.failedPayments?.count || 0 }}</p>
                </div>
                <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
                  <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Value</p>
                  <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ (paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
                </div>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Methods Breakdown</h3>
              <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[400, paymentMethodsData.length * 50 || 250]"
                [scheme]="paymentColorScheme" [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-pie-chart>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Collection Trends</h3>
              <ngx-charts-line-chart [results]="collectionTrendsData" [view]="[600, collectionTrendsData.length * 50 || 200]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Collection Amount ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
            </div>
          </div>
          <ng-template #paymentLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl mb-6"></p-skeleton>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Sales Forecast Widget -->
        <ng-container *ngIf="widget.id === 'salesForecast' && !error['salesForecast']">
          <div class="p-6" *ngIf="!isForecastLoading; else forecastLoading">
            <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data." class="rounded-xl"
              [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
          </div>
          <ng-template #forecastLoading>
            <div class="p-6">
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>
      </p-panel>
    </gridstack-item>
  </gridstack>

  <p-dialog [header]="selectedPanelTitle" [(visible)]="showDialog" [modal]="true" styleClass="w-full max-w-7xl shadow-lg rounded-xl"
    [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}" [draggable]="false">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center w-full px-4 py-2">
        <span class="text-xl font-semibold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelTitle }}</span>
      </div>
    </ng-template>
    <ng-container *ngIf="selectedPanelTitle === 'KPI Summary' && !error['kpiSummary']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Revenue</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Change: {{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Gross Profit</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Margin: {{ selectedPanelData?.kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Sales</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Avg. Order: ${{ selectedPanelData?.kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">LTV: ${{ selectedPanelData?.enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Trend</h3>
          <ngx-charts-line-chart [results]="revenueTrendData" [view]="[800, revenueTrendData.length * 60 || 300]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Selling Products</h3>
          <p-table [value]="selectedPanelData?.overview?.topSellingProducts" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Quantity</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.productName }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.totalQuantity }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Charts Overview' && !error['chartsOverview']">
      <div class="p-6">
        <p-message severity="info" text="Charts data not yet available. Please provide API response data." class="rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Product Analytics' && !error['productAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Inventory Value</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Items in Stock</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Low Stock</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Performance by Category</h3>
          <ngx-charts-bar-vertical [results]="categoryData" [view]="[800, categoryData.length * 60 || 400]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-bar-vertical>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Products by Revenue</h3>
          <p-table [value]="selectedPanelData?.productAnalytics?.topPerformingProducts?.topByRevenue" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Brand</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Profit</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.title }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.brand }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.grossProfit?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Inventory Turnover</h3>
          <p-message severity="info" text="Inventory turnover data not yet available. Please provide API response data." class="rounded-xl"
            [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Customer Analytics' && !error['customerAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.customerAnalytics?.summary?.newCustomers || 0 }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Repeat Customer Rate</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Retention rate</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Customers by Lifetime Value</h3>
          <p-table [value]="selectedPanelData?.customerAnalytics?.topCustomersLifetime" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Name</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Email</th>
                <th class="text-right p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Lifetime Value</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-customer>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3 font-medium" [style]="{'font-family': 'var(--font-body)'}">{{ customer.fullname }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ customer.email }}</td>
                <td class="p-3 text-right" [style]="{'font-family': 'var(--font-body)'}">${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3" class="text-center py-4" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">No customer data available</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Breakdown</h3>
          <p-message *ngIf="!selectedPanelData?.customerAnalytics?.revenueBreakdown?.length" severity="info"
            text="Revenue breakdown data not available for this period." class="rounded-xl"
            [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Payment Analytics' && !error['paymentAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Billed</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Collected</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Collections</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Collection Rate</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Success rate</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Status</h3>
          <div class="flex items-center gap-4">
            <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
              <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Payments</p>
              <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.paymentAnalytics?.failedPayments?.count || 0 }}</p>
            </div>
            <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
              <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Value</p>
              <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ (selectedPanelData?.paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
            </div>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Methods Breakdown</h3>
          <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[600, paymentMethodsData.length * 50 || 300]"
            [scheme]="paymentColorScheme" [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-pie-chart>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Collection Trends</h3>
          <ngx-charts-line-chart [results]="collectionTrendsData" [view]="[800, collectionTrendsData.length * 60 || 300]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Collection Amount ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Sales Forecast' && !error['salesForecast']">
      <div class="p-6">
        <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data." class="rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
      </div>
    </ng-container>
  </p-dialog>
</div>
<!-- 
<p-toast position="top-right"></p-toast>
<div class="admin-dashboard bg-gray-100 dark:bg-gray-900 min-h-screen p-6" [@fadeIn]="true">
  <p-toolbar styleClass="sticky top-0 z-20 bg-white dark:bg-gray-850 shadow-lg rounded-xl mb-6 se-filter-bar">
    <div class="p-toolbar-group-left">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 tracking-tight">Admin Dashboard</h2>
    </div>
    <div class="p-toolbar-group-center flex flex-wrap gap-4 items-center">
      <p-select [options]="periodOptions" [(ngModel)]="selectedPeriod" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-48 rounded-lg bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600"
        (onChange)="onFilterChange()"></p-select>
      <p-select [options]="limitOptions" [(ngModel)]="dataLimit" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-36 rounded-lg bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600"
        (onChange)="onFilterChange()"></p-select>
      <div *ngIf="selectedPeriod === 'custom'" class="flex gap-3 items-center">
        <p-calendar [(ngModel)]="customDateRange" selectionMode="range" [readonlyInput]="true"
          placeholder="Select Date Range" dateFormat="dd/mm/yy"
          styleClass="p-inputtext-sm w-72 rounded-lg bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600"></p-calendar>
        <button pButton type="button" label="Apply" icon="pi pi-check" class="p-button-sm p-button-success rounded-lg"
          (click)="onApplyCustomRange()"></button>
      </div>
      <p-progressSpinner *ngIf="isLoading" styleClass="w-6 h-6" strokeWidth="4"></p-progressSpinner>
    </div>
    <div class="p-toolbar-group-right flex gap-3">
      <button pButton pRipple type="button" [icon]="isGridLocked ? 'pi pi-lock' : 'pi pi-lock-open'"
        [label]="isGridLocked ? 'Unlock Grid' : 'Lock Grid'" class="p-button-outlined p-button-sm rounded-lg"
        (click)="toggleLockGrid()"></button>
      <button pButton type="button" icon="pi pi-save" label="Save Layout" class="p-button-sm p-button-info rounded-lg"
        (click)="saveLayout()"></button>
      <button pButton type="button" icon="pi pi-refresh" label="Reload All" class="p-button-sm p-button-secondary rounded-lg"
        (click)="triggerRefresh()"></button>
      <button pButton type="button" icon="pi pi-code" label="Toggle JSON" class="p-button-sm p-button-outlined rounded-lg"
        (click)="showJson = !showJson"></button>
    </div>
  </p-toolbar>

  <p-panel *ngIf="showJson" header="Dashboard Data (Debug)" styleClass="mb-6 bg-white dark:bg-gray-850 shadow-lg rounded-xl">
    <pre class="bg-gray-900 text-gray-200 p-4 rounded-lg font-mono text-sm overflow-auto">
      {{ { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales } | json }}
    </pre>
  </p-panel>

  <div *ngIf="isLoading" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <p-skeleton width="100%" height="12rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
  </div>

  <gridstack [options]="gridOptions" *ngIf="!isLoading" class="relative">
    <gridstack-item *ngFor="let widget of widgets; trackBy: identify" [options]="widget">
      <p-panel [header]="widget.content ?? 'Unknown Widget'"
        styleClass="h-full bg-white dark:bg-gray-850 shadow-lg rounded-xl hover:shadow-xl transition-shadow duration-300"
        [@panelAnimation]>
        <ng-template pTemplate="header">
          <div class="flex justify-between items-center w-full px-4 py-2">
            <span class="text-xl font-semibold text-gray-900 dark:text-gray-100">{{ widget.content ?? 'Unknown Widget' }}</span>
            <div class="flex gap-2">
              <button pButton icon="pi pi-refresh" class="p-button-text p-button-sm" (click)="refreshWidget(widget.id ?? '')"></button>
              <button pButton icon="pi pi-window-maximize" class="p-button-text p-button-sm"
                (click)="openDialog(widget.content ?? 'Unknown Widget', { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales })"></button>
            </div>
          </div>
        </ng-template>
        <p-message *ngIf="widget.id && error[widget.id]" severity="error" class="mb-4">
          <button pButton label="Retry" class="p-button-sm p-button-danger" (click)="refreshWidget(widget.id ?? '')"></button>
        </p-message>

        KPI Summary Widget
        <ng-container *ngIf="widget.id === 'kpiSummary' && !error['kpiSummary']">
          <div class="p-6 space-y-6" *ngIf="!isKpiLoading; else kpiLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
              <div class="bg-blue-50 dark:bg-blue-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300 mb-2">Total Revenue</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Change: {{ enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
              </div>
              <div class="bg-green-50 dark:bg-green-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-green-600 dark:text-green-300 mb-2">Gross Profit</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Margin: {{ kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
              </div>
              <div class="bg-purple-50 dark:bg-purple-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-purple-600 dark:text-purple-300 mb-2">Total Sales</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Avg. Order: ${{ kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="bg-yellow-50 dark:bg-yellow-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-yellow-600 dark:text-yellow-300 mb-2">New Customers</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">LTV: ${{ enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
              </div>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Revenue Trend</h3>
              <ngx-charts-line-chart [results]="revenueTrendData" [view]="[600, revenueTrendData.length * 50 || 200]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full"></ngx-charts-line-chart>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Top Selling Products</h3>
              <p-table [value]="overview?.topSellingProducts" [tableStyle]="{ 'min-width': '40rem' }">
                <ng-template pTemplate="header">
                  <tr>
                    <th class="text-left p-3">Image</th>
                    <th class="text-left p-3">Product</th>
                    <th class="text-left p-3">Quantity</th>
                    <th class="text-left p-3">Revenue</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                    <td class="p-3">{{ product.productName }}</td>
                    <td class="p-3">{{ product.totalQuantity }}</td>
                    <td class="p-3">${{ product.totalRevenue?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
          <ng-template #kpiLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Charts Overview Widget
        <ng-container *ngIf="widget.id === 'chartsOverview' && !error['chartsOverview']">
          <div class="p-6" *ngIf="!isChartsLoading; else chartsLoading">
            <p-message severity="info" text="Charts data not yet available. Please provide API response data." class="rounded-lg"></p-message>
          </div>
          <ng-template #chartsLoading>
            <div class="p-6">
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Product Analytics Widget
        <ng-container *ngIf="widget.id === 'productAnalytics' && !error['productAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isProductLoading; else productLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              <div class="bg-blue-50 dark:bg-blue-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300 mb-2">Total Inventory Value</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="bg-green-50 dark:bg-green-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-green-600 dark:text-green-300 mb-2">Items in Stock</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
              </div>
              <div class="bg-red-50 dark:bg-red-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-red-600 dark:text-red-300 mb-2">Low Stock</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
              </div>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Performance by Category</h3>
              <ngx-charts-bar-vertical [results]="categoryData" [view]="[600, categoryData.length * 60 || 300]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
                class="w-full"></ngx-charts-bar-vertical>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Top Products by Revenue</h3>
              <p-table [value]="productAnalytics?.topPerformingProducts?.topByRevenue" [tableStyle]="{ 'min-width': '40rem' }">
                <ng-template pTemplate="header">
                  <tr>
                    <th class="text-left p-3">Image</th>
                    <th class="text-left p-3">Product</th>
                    <th class="text-left p-3">Brand</th>
                    <th class="text-left p-3">Revenue</th>
                    <th class="text-left p-3">Profit</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                    <td class="p-3">{{ product.title }}</td>
                    <td class="p-3">{{ product.brand }}</td>
                    <td class="p-3">${{ product.totalRevenue?.toLocaleString() }}</td>
                    <td class="p-3">${{ product.grossProfit?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Inventory Turnover</h3>
              <p-message severity="info" text="Inventory turnover data not yet available. Please provide API response data." class="rounded-lg"></p-message>
            </div>
          </div>
          <ng-template #productLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl mb-6"></p-skeleton>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Customer Analytics Widget
        <ng-container *ngIf="widget.id === 'customerAnalytics' && !error['customerAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isCustomerLoading; else customerLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div class="bg-indigo-50 dark:bg-indigo-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-indigo-600 dark:text-indigo-300 mb-2">New Customers</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ customerAnalytics?.summary?.newCustomers || 0 }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">This period</p>
              </div>
              <div class="bg-orange-50 dark:bg-orange-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-orange-600 dark:text-orange-300 mb-2">Repeat Customer Rate</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Retention rate</p>
              </div>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Top Customers by Lifetime Value</h3>
              <p-table [value]="customerAnalytics?.topCustomersLifetime" [tableStyle]="{ 'min-width': '40rem' }">
                <ng-template pTemplate="header">
                  <tr>
                    <th class="text-left p-3">Name</th>
                    <th class="text-left p-3">Email</th>
                    <th class="text-right p-3">Lifetime Value</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-customer>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <td class="p-3 font-medium">{{ customer.fullname }}</td>
                    <td class="p-3">{{ customer.email }}</td>
                    <td class="p-3 text-right">${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="3" class="text-center py-4">No customer data available</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Revenue Breakdown</h3>
              <p-message *ngIf="!customerAnalytics?.revenueBreakdown?.length" severity="info" text="Revenue breakdown data not available for this period." class="rounded-lg"></p-message>
            </div>
          </div>
          <ng-template #customerLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="18rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Payment Analytics Widget
        <ng-container *ngIf="widget.id === 'paymentAnalytics' && !error['paymentAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isPaymentLoading; else paymentLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              <div class="bg-blue-50 dark:bg-blue-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300 mb-2">Total Billed</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">This period</p>
              </div>
              <div class="bg-green-50 dark:bg-green-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-green-600 dark:text-green-300 mb-2">Total Collected</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Collections</p>
              </div>
              <div class="bg-purple-50 dark:bg-purple-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-sm font-medium text-purple-600 dark:text-purple-300 mb-2">Collection Rate</h3>
                <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Success rate</p>
              </div>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Payment Status</h3>
              <div class="flex items-center gap-4">
                <div class="bg-green-50 dark:bg-green-900 p-4 rounded-xl flex-1">
                  <p class="text-sm font-medium text-green-600 dark:text-green-300">Failed Payments</p>
                  <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ paymentAnalytics?.failedPayments?.count || 0 }}</p>
                </div>
                <div class="bg-red-50 dark:bg-red-900 p-4 rounded-xl flex-1">
                  <p class="text-sm font-medium text-red-600 dark:text-red-300">Failed Value</p>
                  <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">${{ (paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
                </div>
              </div>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Payment Methods Breakdown</h3>
              <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[400, paymentMethodsData.length * 50 || 250]"
                [scheme]="paymentColorScheme" [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
                class="w-full"></ngx-charts-pie-chart>
            </div>
            <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Collection Trends</h3>
              <ngx-charts-line-chart [results]="collectionTrendsData" [view]="[600, collectionTrendsData.length * 50 || 200]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Collection Amount ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full"></ngx-charts-line-chart>
            </div>
          </div>
          <ng-template #paymentLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl mb-6"></p-skeleton>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Sales Forecast Widget
        <ng-container *ngIf="widget.id === 'salesForecast' && !error['salesForecast']">
          <div class="p-6" *ngIf="!isForecastLoading; else forecastLoading">
            <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data." class="rounded-lg"></p-message>
          </div>
          <ng-template #forecastLoading>
            <div class="p-6">
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>
      </p-panel>
    </gridstack-item>
  </gridstack>

  <p-dialog [header]="selectedPanelTitle" [(visible)]="showDialog" [modal]="true" styleClass="w-full max-w-7xl bg-white dark:bg-gray-850 shadow-lg rounded-xl"
    [draggable]="false">
    <ng-container *ngIf="selectedPanelTitle === 'KPI Summary' && !error['kpiSummary']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-blue-50 dark:bg-blue-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300 mb-2">Total Revenue</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Change: {{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
          </div>
          <div class="bg-green-50 dark:bg-green-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-green-600 dark:text-green-300 mb-2">Gross Profit</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Margin: {{ selectedPanelData?.kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
          </div>
          <div class="bg-purple-50 dark:bg-purple-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-purple-600 dark:text-purple-300 mb-2">Total Sales</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Avg. Order: ${{ selectedPanelData?.kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="bg-yellow-50 dark:bg-yellow-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-yellow-600 dark:text-yellow-300 mb-2">New Customers</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">LTV: ${{ selectedPanelData?.enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Revenue Trend</h3>
          <ngx-charts-line-chart [results]="revenueTrendData" [view]="[800, revenueTrendData.length * 60 || 300]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
            class="w-full"></ngx-charts-line-chart>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Top Selling Products</h3>
          <p-table [value]="selectedPanelData?.overview?.topSellingProducts" [tableStyle]="{ 'min-width': '40rem' }">
            <ng-template pTemplate="header">
              <tr>
                <th class="text-left p-3">Image</th>
                <th class="text-left p-3">Product</th>
                <th class="text-left p-3">Quantity</th>
                <th class="text-left p-3">Revenue</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                <td class="p-3">{{ product.productName }}</td>
                <td class="p-3">{{ product.totalQuantity }}</td>
                <td class="p-3">${{ product.totalRevenue?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Charts Overview' && !error['chartsOverview']">
      <div class="p-6">
        <p-message severity="info" text="Charts data not yet available. Please provide API response data." class="rounded-lg"></p-message>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Product Analytics' && !error['productAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="bg-blue-50 dark:bg-blue-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300 mb-2">Total Inventory Value</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ selectedPanelData?.productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="bg-green-50 dark:bg-green-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-green-600 dark:text-green-300 mb-2">Items in Stock</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ selectedPanelData?.productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
          </div>
          <div class="bg-red-50 dark:bg-red-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-red-600 dark:text-red-300 mb-2">Low Stock</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ selectedPanelData?.productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Performance by Category</h3>
          <ngx-charts-bar-vertical [results]="categoryData" [view]="[800, categoryData.length * 60 || 400]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
            class="w-full"></ngx-charts-bar-vertical>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Top Products by Revenue</h3>
          <p-table [value]="selectedPanelData?.productAnalytics?.topPerformingProducts?.topByRevenue" [tableStyle]="{ 'min-width': '40rem' }">
            <ng-template pTemplate="header">
              <tr>
                <th class="text-left p-3">Image</th>
                <th class="text-left p-3">Product</th>
                <th class="text-left p-3">Brand</th>
                <th class="text-left p-3">Revenue</th>
                <th class="text-left p-3">Profit</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                <td class="p-3">{{ product.title }}</td>
                <td class="p-3">{{ product.brand }}</td>
                <td class="p-3">${{ product.totalRevenue?.toLocaleString() }}</td>
                <td class="p-3">${{ product.grossProfit?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Inventory Turnover</h3>
          <p-message severity="info" text="Inventory turnover data not yet available. Please provide API response data." class="rounded-lg"></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Customer Analytics' && !error['customerAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="bg-indigo-50 dark:bg-indigo-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-indigo-600 dark:text-indigo-300 mb-2">New Customers</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ selectedPanelData?.customerAnalytics?.summary?.newCustomers || 0 }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">This period</p>
          </div>
          <div class="bg-orange-50 dark:bg-orange-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-orange-600 dark:text-orange-300 mb-2">Repeat Customer Rate</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ selectedPanelData?.customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Retention rate</p>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Top Customers by Lifetime Value</h3>
          <p-table [value]="selectedPanelData?.customerAnalytics?.topCustomersLifetime" [tableStyle]="{ 'min-width': '40rem' }">
            <ng-template pTemplate="header">
              <tr>
                <th class="text-left p-3">Name</th>
                <th class="text-left p-3">Email</th>
                <th class="text-right p-3">Lifetime Value</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-customer>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                <td class="p-3 font-medium">{{ customer.fullname }}</td>
                <td class="p-3">{{ customer.email }}</td>
                <td class="p-3 text-right">${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3" class="text-center py-4">No customer data available</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Revenue Breakdown</h3>
          <p-message *ngIf="!selectedPanelData?.customerAnalytics?.revenueBreakdown?.length" severity="info"
            text="Revenue breakdown data not available for this period." class="rounded-lg"></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Payment Analytics' && !error['paymentAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="bg-blue-50 dark:bg-blue-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300 mb-2">Total Billed</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ selectedPanelData?.paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">This period</p>
          </div>
          <div class="bg-green-50 dark:bg-green-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-green-600 dark:text-green-300 mb-2">Total Collected</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">${{ selectedPanelData?.paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Collections</p>
          </div>
          <div class="bg-purple-50 dark:bg-purple-900 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
            <h3 class="text-sm font-medium text-purple-600 dark:text-purple-300 mb-2">Collection Rate</h3>
            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ selectedPanelData?.paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Success rate</p>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Payment Status</h3>
          <div class="flex items-center gap-4">
            <div class="bg-green-50 dark:bg-green-900 p-4 rounded-xl flex-1">
              <p class="text-sm font-medium text-green-600 dark:text-green-300">Failed Payments</p>
              <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ selectedPanelData?.paymentAnalytics?.failedPayments?.count || 0 }}</p>
            </div>
            <div class="bg-red-50 dark:bg-red-900 p-4 rounded-xl flex-1">
              <p class="text-sm font-medium text-red-600 dark:text-red-300">Failed Value</p>
              <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">${{ (selectedPanelData?.paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Payment Methods Breakdown</h3>
          <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[600, paymentMethodsData.length * 50 || 300]"
            [scheme]="paymentColorScheme" [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
            class="w-full"></ngx-charts-pie-chart>
        </div>
        <div class="bg-white dark:bg-gray-850 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">Collection Trends</h3>
          <ngx-charts-line-chart [results]="collectionTrendsData" [view]="[800, collectionTrendsData.length * 60 || 300]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Collection Amount ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
            class="w-full"></ngx-charts-line-chart>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Sales Forecast' && !error['salesForecast']">
      <div class="p-6">
        <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data." class="rounded-lg"></p-message>
      </div>
    </ng-container>
  </p-dialog>
</div> -->

<!-- <p-toast position="top-right"></p-toast>
<div class="admin-dashboard bg-gray-100 dark:bg-gray-900 min-h-screen p-4" [@fadeIn]="true">
  <p-toolbar styleClass="sticky top-0 z-10 bg-white dark:bg-gray-800 shadow-md rounded-lg mb-4">
    <div class="p-toolbar-group-left">
      <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Admin Dashboard</h2>
    </div>
    <div class="p-toolbar-group-center flex gap-3 items-center">
      <p-select [options]="periodOptions" [(ngModel)]="selectedPeriod" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-40" (onChange)="onFilterChange()"></p-select>
      <p-select [options]="limitOptions" [(ngModel)]="dataLimit" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-32" (onChange)="onFilterChange()"></p-select>
      <div *ngIf="selectedPeriod === 'custom'" class="flex gap-2">
        <p-calendar [(ngModel)]="customDateRange" selectionMode="range" [readonlyInput]="true"
          placeholder="Select a date range" dateFormat="dd/mm/yy" styleClass="p-inputtext-sm w-64"></p-calendar>
        <button pButton type="button" label="Apply" icon="pi pi-check" class="p-button-sm p-button-success"
          (click)="onApplyCustomRange()"></button>
      </div>
      <p-progressSpinner *ngIf="isLoading" styleClass="w-6 h-6" strokeWidth="4"></p-progressSpinner>
    </div>
    <div class="p-toolbar-group-right flex gap-2">
      <button pButton pRipple type="button" [icon]="isGridLocked ? 'pi pi-lock' : 'pi pi-lock-open'"
        [label]="isGridLocked ? 'Unlock Grid' : 'Lock Grid'" class="p-button-outlined"
        (click)="toggleLockGrid()"></button>
      <button pButton type="button" icon="pi pi-save" label="Save Layout" class="p-button-info"
        (click)="saveLayout()"></button>
      <button pButton type="button" icon="pi pi-refresh" label="Reload All" class="p-button-secondary"
        (click)="triggerRefresh()"></button>
      <button pButton type="button" icon="pi pi-code" label="Toggle JSON" class="p-button-outlined"
        (click)="showJson = !showJson"></button>
    </div>
  </p-toolbar>

  <p-panel *ngIf="showJson" header="Dashboard Data (Debug)" styleClass="mb-4">
    <pre
      class="bg-gray-800 text-white p-4 rounded-lg">{{ { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales } | json }}</pre>
  </p-panel>

  <div *ngIf="isLoading" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <p-skeleton width="100%" height="12rem" styleClass="mb-4 rounded-lg"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-4 rounded-lg"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-4 rounded-lg"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-4 rounded-lg"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-4 rounded-lg"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-4 rounded-lg"></p-skeleton>
  </div>

  <gridstack [options]="gridOptions" *ngIf="!isLoading" class="relative">
    <gridstack-item *ngFor="let widget of widgets; trackBy: identify" [options]="widget">
      <p-panel [header]="widget.content ?? 'Unknown Widget'"
        styleClass="h-full bg-white dark:bg-gray-800 shadow-md rounded-lg hover:shadow-lg transition-shadow"
        [@panelAnimation]>
        <ng-template pTemplate="header">
          <div class="flex justify-between items-center w-full">
            <span class="text-lg font-semibold">{{ widget.content ?? 'Unknown Widget' }}</span>
            <div class="flex gap-2">
              <button pButton icon="pi pi-refresh" class="p-button-text"
                (click)="refreshWidget(widget.id ?? '')"></button>
              <button pButton icon="pi pi-window-maximize" class="p-button-text"
                (click)="openDialog(widget.content ?? 'Unknown Widget', { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales })"></button>
            </div>
          </div>
        </ng-template>
        <p-message *ngIf="widget.id && error[widget.id]" severity="error">
          <button pButton label="Retry" class="p-button-sm p-button-danger" (click)="refreshWidget(widget.id ?? '')"></button>
        </p-message>

        <ng-container *ngIf="widget.id === 'kpiSummary' && !error['kpiSummary']">
          <div class="p-4 space-y-6" *ngIf="!isKpiLoading; else kpiLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300">Total Revenue</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">${{
                  enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Change: {{
                  enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
              </div>
              <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-green-600 dark:text-green-300">Gross Profit</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">${{
                  enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Margin: {{
                  kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
              </div>
              <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-purple-600 dark:text-purple-300">Total Sales</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">{{
                  enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Avg. Order: ${{
                  kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-yellow-600 dark:text-yellow-300">New Customers</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">{{
                  enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">LTV: ${{
                  enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
              </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold mb-2">Revenue Trend</h3>
              <ngx-charts-line-chart [results]="revenueTrendData" [view]="[600, 150]" [xAxis]="showXAxis"
                [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)" [showXAxisLabel]="showXAxisLabel"
                [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full h-36"></ngx-charts-line-chart>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold mb-2">Top Selling Products</h3>
              <p-table [value]="overview?.topSellingProducts" [tableStyle]="{ 'min-width': '50rem' }">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Image</th>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Revenue</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr>
                    <td><img [src]="product.thumbnail" alt="product" class="w-12 h-12 object-cover rounded"></td>
                    <td>{{ product.productName }}</td>
                    <td>{{ product.totalQuantity }}</td>
                    <td>${{ product.totalRevenue?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
          <ng-template #kpiLoading>
            <div class="p-4">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="12rem" styleClass="rounded-lg"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Charts Overview Widget
        <ng-container *ngIf="widget.id === 'chartsOverview' && !error['chartsOverview']">
          <div class="p-4" *ngIf="!isChartsLoading; else chartsLoading">
            <p-message severity="info"
              text="Charts data not yet available. Please provide API response data."></p-message>
          </div>
          <ng-template #chartsLoading>
            <div class="p-4">
              <p-skeleton width="100%" height="20rem" styleClass="rounded-lg"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Product Analytics Widget
        <ng-container *ngIf="widget.id === 'productAnalytics' && !error['productAnalytics']">
          <div class="p-4 space-y-6" *ngIf="!isProductLoading; else productLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300">Total Inventory Value</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">${{
                  productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-green-600 dark:text-green-300">Items in Stock</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">{{
                  productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
              </div>
              <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-red-600 dark:text-red-300">Low Stock</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">{{
                  productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
              </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold mb-2">Performance by Category</h3>
              <ngx-charts-bar-vertical [results]="categoryData" [view]="chartView" [xAxis]="showXAxis"
                [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)" [showXAxisLabel]="showXAxisLabel"
                [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
                class="w-full h-64"></ngx-charts-bar-vertical>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold mb-2">Top Products by Revenue</h3>
              <p-table [value]="productAnalytics?.topPerformingProducts?.topByRevenue"
                [tableStyle]="{ 'min-width': '50rem' }">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Image</th>
                    <th>Product</th>
                    <th>Brand</th>
                    <th>Revenue</th>
                    <th>Profit</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr>
                    <td><img [src]="product.thumbnail" alt="product" class="w-12 h-12 object-cover rounded"></td>
                    <td>{{ product.title }}</td>
                    <td>{{ product.brand }}</td>
                    <td>${{ product.totalRevenue?.toLocaleString() }}</td>
                    <td>${{ product.grossProfit?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold mb-2">Inventory Turnover</h3>
              <p-message severity="info"
                text="Inventory turnover data not yet available. Please provide API response data."></p-message>
            </div>
          </div>
          <ng-template #productLoading>
            <div class="p-4">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="20rem" styleClass="rounded-lg mb-4"></p-skeleton>
              <p-skeleton width="100%" height="12rem" styleClass="rounded-lg"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Customer Analytics Widget
        <ng-container *ngIf="widget.id === 'customerAnalytics' && !error['customerAnalytics']">
          <div class="p-4 space-y-6" *ngIf="!isCustomerLoading; else customerLoading">
            Customer Summary KPI Cards
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="bg-indigo-50 dark:bg-indigo-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-indigo-600 dark:text-indigo-300">New Customers</h3>
                <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{
                  customerAnalytics?.summary?.newCustomers || 0 }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">This period</p>
              </div>
              <div class="bg-orange-50 dark:bg-orange-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-orange-600 dark:text-orange-300">Repeat Customer Rate</h3>
                <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{
                  customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Retention rate</p>
              </div>
            </div>

            Top Customers Lifetime Table
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold mb-2">Top Customers by Lifetime Value</h3>
              <p-table [value]="customerAnalytics?.topCustomersLifetime" [tableStyle]="{ 'min-width': '50rem' }">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Lifetime Value</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-customer>
                  <tr>
                    <td class="font-medium">{{ customer.fullname }}</td>
                    <td>{{ customer.email }}</td>
                    <td class="text-right">${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="3" class="text-center py-4">No customer data available</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>

            Revenue Breakdown Placeholder
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"
              *ngIf="!customerAnalytics?.revenueBreakdown?.length">
              <h3 class="text-lg font-semibold mb-2">Revenue Breakdown</h3>
              <p-message severity="info" text="Revenue breakdown data not available for this period."></p-message>
            </div>
          </div>
          <ng-template #customerLoading>
            <div class="p-4">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-lg"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-lg"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="16rem" styleClass="rounded-lg"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Payment Analytics Widget
        Payment Analytics Widget
        <ng-container *ngIf="widget.id === 'paymentAnalytics' && !error['paymentAnalytics']">
          <div class="p-4 space-y-6" *ngIf="!isPaymentLoading; else paymentLoading">
            Financial Health KPI Cards
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300">Total Billed</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">${{
                  paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">This period</p>
              </div>
              <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-green-600 dark:text-green-300">Total Collected</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">${{
                  paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Collections</p>
              </div>
              <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg shadow">
                <h3 class="text-sm font-medium text-purple-600 dark:text-purple-300">Collection Rate</h3>
                <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">{{
                  paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Success rate</p>
              </div>
            </div>

            Failed Payments Info
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold mb-2">Payment Status</h3>
              <div class="flex items-center gap-4">
                <div class="bg-green-50 dark:bg-green-900 p-3 rounded-lg flex-1">
                  <p class="text-sm font-medium text-green-600 dark:text-green-300">Failed Payments</p>
                  <p class="text-2xl font-bold text-green-800 dark:text-green-200">{{
                    paymentAnalytics?.failedPayments?.count || 0 }}</p>
                </div>
                <div class="bg-red-50 dark:bg-red-900 p-3 rounded-lg flex-1">
                  <p class="text-sm font-medium text-red-600 dark:text-red-300">Failed Value</p>
                  <p class="text-2xl font-bold text-red-800 dark:text-red-200">${{
                    (paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
                </div>
              </div>
            </div>

            Payment Methods Pie Chart
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold mb-2">Payment Methods Breakdown</h3>
              <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[400, 250]" [scheme]="paymentColorScheme"
                [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
                class="w-full h-64"></ngx-charts-pie-chart>
            </div>

            Collection Trends Line Chart
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold mb-2">Collection Trends</h3>
              <ngx-charts-line-chart [results]="collectionTrendsData" [view]="[600, 200]" [xAxis]="showXAxis"
                [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Collection Amount ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full h-48"></ngx-charts-line-chart>
            </div>
          </div>
          <ng-template #paymentLoading>
            <div class="p-4">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
                <p-skeleton width="100%" height="6rem" styleClass="rounded-lg"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="20rem" styleClass="rounded-lg mb-4"></p-skeleton>
              <p-skeleton width="100%" height="12rem" styleClass="rounded-lg"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>
      Sales Forecast Widget
        <ng-container *ngIf="widget.id === 'salesForecast' && !error['salesForecast']">
          <div class="p-4" *ngIf="!isForecastLoading; else forecastLoading">
            <p-message severity="info"
              text="Sales forecast data not yet available. Please provide API response data."></p-message>
          </div>
          <ng-template #forecastLoading>
            <div class="p-4">
              <p-skeleton width="100%" height="20rem" styleClass="rounded-lg"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>
      </p-panel>
    </gridstack-item>
  </gridstack>

  <p-dialog [header]="selectedPanelTitle" [(visible)]="showDialog" [modal]="true" styleClass="w-full max-w-9xl"
    [draggable]="false">
    <ng-container *ngIf="selectedPanelTitle === 'KPI Summary' && !error['kpiSummary']">
      <div class="p-4 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow">
            <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300">Total Revenue</h3>
            <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">${{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">Change: {{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
          </div>
          <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow">
            <h3 class="text-sm font-medium text-green-600 dark:text-green-300">Gross Profit</h3>
            <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">${{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">Margin: {{
              selectedPanelData?.kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
          </div>
          <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg shadow">
            <h3 class="text-sm font-medium text-purple-600 dark:text-purple-300">Total Sales</h3>
            <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">{{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">Avg. Order: ${{
              selectedPanelData?.kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg shadow">
            <h3 class="text-sm font-medium text-yellow-600 dark:text-yellow-300">New Customers</h3>
            <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">{{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">LTV: ${{
              selectedPanelData?.enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-2">Revenue Trend</h3>
          <ngx-charts-line-chart [results]="revenueTrendData" [view]="[800, 300]" [xAxis]="showXAxis"
            [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)" [showXAxisLabel]="showXAxisLabel"
            [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme" class="w-full h-64"></ngx-charts-line-chart>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-2">Top Selling Products</h3>
          <p-table [value]="selectedPanelData?.overview?.topSellingProducts" [tableStyle]="{ 'min-width': '50rem' }">
            <ng-template pTemplate="header">
              <tr>
                <th>Image</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Revenue</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr>
                <td><img [src]="product.thumbnail" alt="product" class="w-12 h-12 object-cover rounded"></td>
                <td>{{ product.productName }}</td>
                <td>{{ product.totalQuantity }}</td>
                <td>${{ product.totalRevenue?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Charts Overview' && !error['chartsOverview']">
      <div class="p-4">
        <p-message severity="info" text="Charts data not yet available. Please provide API response data."></p-message>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Product Analytics' && !error['productAnalytics']">
      <div class="p-4 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg shadow">
            <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300">Total Inventory Value</h3>
            <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">${{
              selectedPanelData?.productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg shadow">
            <h3 class="text-sm font-medium text-green-600 dark:text-green-300">Items in Stock</h3>
            <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">{{
              selectedPanelData?.productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
          </div>
          <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg shadow">
            <h3 class="text-sm font-medium text-red-600 dark:text-red-300">Low Stock</h3>
            <p class="text-2xl font-semibold text-gray-800 dark:text-gray-200">{{
              selectedPanelData?.productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-2">Performance by Category</h3>
          <ngx-charts-bar-vertical [results]="categoryData" [view]="[800, 400]" [xAxis]="showXAxis" [yAxis]="showYAxis"
            xAxisLabel="Category" yAxisLabel="Revenue ($)" [showXAxisLabel]="showXAxisLabel"
            [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
            class="w-full h-80"></ngx-charts-bar-vertical>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-2">Top Products by Revenue</h3>
          <p-table [value]="selectedPanelData?.productAnalytics?.topPerformingProducts?.topByRevenue"
            [tableStyle]="{ 'min-width': '50rem' }">
            <ng-template pTemplate="header">
              <tr>
                <th>Image</th>
                <th>Product</th>
                <th>Brand</th>
                <th>Revenue</th>
                <th>Profit</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr>
                <td><img [src]="product.thumbnail" alt="product" class="w-12 h-12 object-cover rounded"></td>
                <td>{{ product.title }}</td>
                <td>{{ product.brand }}</td>
                <td>${{ product.totalRevenue?.toLocaleString() }}</td>
                <td>${{ product.grossProfit?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-2">Inventory Turnover</h3>
          <p-message severity="info"
            text="Inventory turnover data not yet available. Please provide API response data."></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Customer Analytics' && !error['customerAnalytics']">
      <div class="p-4">
        <p-message severity="info"
          text="Customer analytics data not yet available. Please provide API response data."></p-message>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Payment Analytics' && !error['paymentAnalytics']">
      <div class="p-4">
        <p-message severity="info"
          text="Payment analytics data not yet available. Please provide API response data."></p-message>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Sales Forecast' && !error['salesForecast']">
      <div class="p-4">
        <p-message severity="info"
          text="Sales forecast data not yet available. Please provide API response data."></p-message>
      </div>
    </ng-container>
  </p-dialog>
</div>


 -->
