<!-- <p-toast position="top-right"></p-toast>
<div class="admin-dashboard min-h-screen p-6" [style]="{'background': 'var(--theme-bg-primary)'}" [@fadeIn]="true">
  <p-toolbar styleClass="sticky top-0 z-20 shadow-lg rounded-xl mb-6 se-filter-bar" [style]="{'background': 'var(--theme-bg-secondary)'}">
    <div class="p-toolbar-group-left">
      <h2 class="text-2xl font-bold tracking-tight" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Admin Dashboard</h2>
    </div>
    <div class="p-toolbar-group-center flex flex-wrap gap-4 items-center">
      <p-select [options]="periodOptions" [(ngModel)]="selectedPeriod" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-48 rounded-xl" [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" (onChange)="onFilterChange()"></p-select>
      <p-select [options]="limitOptions" [(ngModel)]="dataLimit" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-36 rounded-xl" [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" (onChange)="onFilterChange()"></p-select>
      <div *ngIf="selectedPeriod === 'custom'" class="flex gap-3 items-center">
        <p-calendar [(ngModel)]="customDateRange" selectionMode="range" [readonlyInput]="true"
          placeholder="Select Date Range" dateFormat="dd/mm/yy"
          styleClass="p-inputtext-sm w-72 rounded-xl" [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" ></p-calendar>
        <button pButton type="button" label="Apply" icon="pi pi-check" class="p-button-sm rounded-xl"
          [style]="{'background': 'var(--theme-accent-primary)', 'color': 'var(--theme-accent-text-color)', 'border': 'none'}" (click)="onApplyCustomRange()"></button>
      </div>
      <p-progressSpinner *ngIf="isLoading" styleClass="w-6 h-6" strokeWidth="4"></p-progressSpinner>
    </div>
    <div class="p-toolbar-group-right flex gap-3">
      <button pButton pRipple type="button" [icon]="isGridLocked ? 'pi pi-lock' : 'pi pi-lock-open'"
        [label]="isGridLocked ? 'Unlock Grid' : 'Lock Grid'" class="p-button-outlined p-button-sm rounded-xl"
        [style]="{'border-color': 'var(--theme-border-primary)', 'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}" (click)="toggleLockGrid()"></button>
      <button pButton type="button" icon="pi pi-save" label="Save Layout" class="p-button-sm rounded-xl"
        [style]="{'background': 'var(--theme-accent-primary)', 'color': 'var(--theme-accent-text-color)', 'border': 'none', 'font-family': 'var(--font-body)'}" (click)="saveLayout()"></button>
      <button pButton type="button" icon="pi pi-refresh" label="Reload All" class="p-button-sm rounded-xl"
        [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" (click)="triggerRefresh()"></button>
      <button pButton type="button" icon="pi pi-code" label="Toggle JSON" class="p-button-sm p-button-outlined rounded-xl"
        [style]="{'border-color': 'var(--theme-border-primary)', 'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}" (click)="showJson = !showJson"></button>
    </div>
  </p-toolbar>

  <p-panel *ngIf="showJson" header="Dashboard Data (Debug)" styleClass="mb-6 shadow-lg rounded-xl"
    [style]="{'background': 'var(--theme-bg-secondary)'}">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center w-full px-4 py-2">
        <span class="text-xl font-semibold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Dashboard Data (Debug)</span>
      </div>
    </ng-template>
    <pre class="p-4 rounded-xl font-mono text-sm overflow-auto"
      [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-secondary)'}">
      {{ { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales } | json }}
    </pre>
  </p-panel>

  <div *ngIf="isLoading" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <p-skeleton width="100%" height="12rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
  </div>

  <gridstack [options]="gridOptions" *ngIf="!isLoading" class="relative">
    <gridstack-item *ngFor="let widget of widgets; trackBy: identify" [options]="widget">
      <p-panel [header]="widget.content ?? 'Unknown Widget'"
        styleClass="h-full shadow-lg rounded-xl hover:shadow-xl transition-shadow duration-300"
        [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}" [@panelAnimation]>
        <ng-template pTemplate="header">
          <div class="flex justify-between items-center w-full px-4 py-2">
            <span class="text-xl font-semibold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ widget.content ?? 'Unknown Widget' }}</span>
            <div class="flex gap-2">
              <button pButton icon="pi pi-refresh" class="p-button-text p-button-sm"
                [style]="{'color': 'var(--theme-text-secondary)'}" (click)="refreshWidget(widget.id ?? '')"></button>
              <button pButton icon="pi pi-window-maximize" class="p-button-text p-button-sm"
                [style]="{'color': 'var(--theme-text-secondary)'}" (click)="openDialog(widget.content ?? 'Unknown Widget', { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales })"></button>
            </div>
          </div>
        </ng-template>
        <p-message *ngIf="widget.id && error[widget.id]" severity="error" class="mb-4 rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>

        KPI Summary Widget
        <ng-container *ngIf="widget.id === 'kpiSummary' && !error['kpiSummary']">
          <div class="p-6 space-y-6" *ngIf="!isKpiLoading; else kpiLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Revenue</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Change: {{ enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Gross Profit</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Margin: {{ kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Sales</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Avg. Order: ${{ kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">LTV: ${{ enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Trend</h3>
              <ngx-charts-line-chart [results]="revenueTrendData" [view]="[600, revenueTrendData.length * 50 || 200]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Selling Products</h3>
              <p-table [value]="overview?.topSellingProducts" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Quantity</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.productName }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.totalQuantity }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
          <ng-template #kpiLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Charts Overview Widget
        <ng-container *ngIf="widget.id === 'chartsOverview' && !error['chartsOverview']">
          <div class="p-6" *ngIf="!isChartsLoading; else chartsLoading">
            <p-message severity="info" text="Charts data not yet available. Please provide API response data." class="rounded-xl"
              [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
          </div>
          <ng-template #chartsLoading>
            <div class="p-6">
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Product Analytics Widget
        <ng-container *ngIf="widget.id === 'productAnalytics' && !error['productAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isProductLoading; else productLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Inventory Value</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Items in Stock</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Low Stock</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Performance by Category</h3>
              <ngx-charts-bar-vertical [results]="categoryData" [view]="[600, categoryData.length * 60 || 300]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-bar-vertical>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Products by Revenue</h3>
              <p-table [value]="productAnalytics?.topPerformingProducts?.topByRevenue" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Brand</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Profit</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.title }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.brand }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.grossProfit?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Inventory Turnover</h3>
              <p-message severity="info" text="Inventory turnover data not yet available. Please provide API response data." class="rounded-xl"
                [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
            </div>
          </div>
          <ng-template #productLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl mb-6"></p-skeleton>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Customer Analytics Widget
        <ng-container *ngIf="widget.id === 'customerAnalytics' && !error['customerAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isCustomerLoading; else customerLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ customerAnalytics?.summary?.newCustomers || 0 }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Repeat Customer Rate</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Retention rate</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Customers by Lifetime Value</h3>
              <p-table [value]="customerAnalytics?.topCustomersLifetime" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Name</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Email</th>
                    <th class="text-right p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Lifetime Value</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-customer>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-3 font-medium" [style]="{'font-family': 'var(--font-body)'}">{{ customer.fullname }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ customer.email }}</td>
                    <td class="p-3 text-right" [style]="{'font-family': 'var(--font-body)'}">${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="3" class="text-center py-4" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">No customer data available</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Breakdown</h3>
              <p-message *ngIf="!customerAnalytics?.revenueBreakdown?.length" severity="info"
                text="Revenue breakdown data not available for this period." class="rounded-xl"
                [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
            </div>
          </div>
          <ng-template #customerLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="18rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Payment Analytics Widget
        <ng-container *ngIf="widget.id === 'paymentAnalytics' && !error['paymentAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isPaymentLoading; else paymentLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Billed</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Collected</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Collections</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Collection Rate</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Success rate</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Status</h3>
              <div class="flex items-center gap-4">
                <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
                  <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Payments</p>
                  <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ paymentAnalytics?.failedPayments?.count || 0 }}</p>
                </div>
                <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
                  <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Value</p>
                  <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ (paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
                </div>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Methods Breakdown</h3>
              <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[400, paymentMethodsData.length * 50 || 250]"
                [scheme]="paymentColorScheme" [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-pie-chart>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Collection Trends</h3>
              <ngx-charts-line-chart [results]="collectionTrendsData" [view]="[600, collectionTrendsData.length * 50 || 200]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Collection Amount ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
            </div>
          </div>
          <ng-template #paymentLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl mb-6"></p-skeleton>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Sales Forecast Widget
        <ng-container *ngIf="widget.id === 'salesForecast' && !error['salesForecast']">
          <div class="p-6" *ngIf="!isForecastLoading; else forecastLoading">
            <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data." class="rounded-xl"
              [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
          </div>
          <ng-template #forecastLoading>
            <div class="p-6">
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>
      </p-panel>
    </gridstack-item>
  </gridstack>

  <p-dialog [header]="selectedPanelTitle" [(visible)]="showDialog" [modal]="true" styleClass="w-full max-w-9xl shadow-lg rounded-xl"
    [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}" [draggable]="false">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center w-full px-4 py-2">
        <span class="text-xl font-semibold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelTitle }}</span>
      </div>
    </ng-template>
    <ng-container *ngIf="selectedPanelTitle === 'KPI Summary' && !error['kpiSummary']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Revenue</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Change: {{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Gross Profit</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Margin: {{ selectedPanelData?.kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Sales</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Avg. Order: ${{ selectedPanelData?.kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">LTV: ${{ selectedPanelData?.enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Trend</h3>
          <ngx-charts-line-chart [results]="revenueTrendData" [view]="[800, revenueTrendData.length * 60 || 300]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Selling Products</h3>
          <p-table [value]="selectedPanelData?.overview?.topSellingProducts" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Quantity</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.productName }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.totalQuantity }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Charts Overview' && !error['chartsOverview']">
      <div class="p-6">
        <p-message severity="info" text="Charts data not yet available. Please provide API response data." class="rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Product Analytics' && !error['productAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Inventory Value</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Items in Stock</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Low Stock</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Performance by Category</h3>
          <ngx-charts-bar-vertical [results]="categoryData" [view]="[800, categoryData.length * 60 || 400]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-bar-vertical>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Products by Revenue</h3>
          <p-table [value]="selectedPanelData?.productAnalytics?.topPerformingProducts?.topByRevenue" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Brand</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Profit</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.title }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.brand }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.grossProfit?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Inventory Turnover</h3>
          <p-message severity="info" text="Inventory turnover data not yet available. Please provide API response data." class="rounded-xl"
            [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Customer Analytics' && !error['customerAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.customerAnalytics?.summary?.newCustomers || 0 }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Repeat Customer Rate</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Retention rate</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Customers by Lifetime Value</h3>
          <p-table [value]="selectedPanelData?.customerAnalytics?.topCustomersLifetime" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Name</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Email</th>
                <th class="text-right p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Lifetime Value</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-customer>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3 font-medium" [style]="{'font-family': 'var(--font-body)'}">{{ customer.fullname }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ customer.email }}</td>
                <td class="p-3 text-right" [style]="{'font-family': 'var(--font-body)'}">${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3" class="text-center py-4" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">No customer data available</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Breakdown</h3>
          <p-message *ngIf="!selectedPanelData?.customerAnalytics?.revenueBreakdown?.length" severity="info"
            text="Revenue breakdown data not available for this period." class="rounded-xl"
            [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Payment Analytics' && !error['paymentAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Billed</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Collected</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Collections</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Collection Rate</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Success rate</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Status</h3>
          <div class="flex items-center gap-4">
            <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
              <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Payments</p>
              <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.paymentAnalytics?.failedPayments?.count || 0 }}</p>
            </div>
            <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
              <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Value</p>
              <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ (selectedPanelData?.paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
            </div>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Methods Breakdown</h3>
          <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[600, paymentMethodsData.length * 50 || 300]"
            [scheme]="paymentColorScheme" [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-pie-chart>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Collection Trends</h3>
          <ngx-charts-line-chart [results]="collectionTrendsData" [view]="[800, collectionTrendsData.length * 60 || 300]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Collection Amount ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Sales Forecast' && !error['salesForecast']">
      <div class="p-6">
        <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data." class="rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
      </div>
    </ng-container>
  </p-dialog>
</div> -->













<p-toast position="top-right"></p-toast>
<div class="admin-dashboard min-h-screen p-4 md:p-6" [style]="{'background': 'var(--theme-bg-primary)'}"
  [@fadeIn]="true">
  <p-toolbar styleClass="sticky top-0 z-20 shadow-md rounded-full mb-4 md:mb-6 se-filter-bar"
    [style]="{'background': 'var(--theme-bg-secondary)', 'padding': '0.5rem 1rem'}">
    <div class="p-toolbar-group-left flex items-center">
      <h2 class="text-xl md:text-2xl font-bold tracking-tight"
        [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Admin Dashboard</h2>
    </div>
    <div class="p-toolbar-group-center flex flex-wrap gap-2 md:gap-4 items-center justify-center flex-1 px-2">
      <p-select [options]="periodOptions" [(ngModel)]="selectedPeriod" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-36 md:w-48 rounded-full"
        [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}"
        (onChange)="onFilterChange()"></p-select>
      <p-select [options]="limitOptions" [(ngModel)]="dataLimit" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-28 md:w-36 rounded-full"
        [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}"
        (onChange)="onFilterChange()"></p-select>
      <div *ngIf="selectedPeriod === 'custom'" class="flex gap-2 items-center w-full md:w-auto">
        <p-calendar [(ngModel)]="customDateRange" selectionMode="range" [readonlyInput]="true"
          placeholder="Select Date Range" dateFormat="dd/mm/yy" styleClass="p-inputtext-sm w-full md:w-72 rounded-full"
          [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}"></p-calendar>
        <button pButton type="button" label="Apply" icon="pi pi-check" class="p-button-sm rounded-full"
          [style]="{'background': 'var(--theme-accent-primary)', 'color': 'var(--theme-accent-text-color)', 'border': 'none'}"
          (click)="onApplyCustomRange()"></button>
      </div>
      <p-progressSpinner *ngIf="isLoading" styleClass="w-5 h-5 md:w-6 md:h-6" strokeWidth="4"></p-progressSpinner>
    </div>
    <div class="p-toolbar-group-right flex gap-2 md:gap-3">
      <button pButton pRipple type="button" [icon]="isGridLocked ? 'pi pi-lock' : 'pi pi-lock-open'"
        [label]="isGridLocked ? 'Unlock' : 'Lock'" class="p-button-outlined p-button-sm rounded-full"
        [style]="{'border-color': 'var(--theme-border-primary)', 'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}"
        (click)="toggleLockGrid()"></button>
      <button pButton type="button" icon="pi pi-save" label="Save" class="p-button-sm rounded-full"
        [style]="{'background': 'var(--theme-accent-primary)', 'color': 'var(--theme-accent-text-color)', 'border': 'none', 'font-family': 'var(--font-body)'}"
        (click)="saveLayout()"></button>
      <button pButton type="button" icon="pi pi-refresh" label="Reload" class="p-button-sm rounded-full"
        [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}"
        (click)="triggerRefresh()"></button>
      <button pButton type="button" icon="pi pi-code" label="JSON" class="p-button-sm p-button-outlined rounded-full"
        [style]="{'border-color': 'var(--theme-border-primary)', 'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}"
        (click)="showJson = !showJson"></button>
    </div>
  </p-toolbar>

  <p-panel *ngIf="showJson" header="Dashboard Data (Debug)" styleClass="mb-6 shadow-md rounded-2xl"
    [style]="{'background': 'var(--theme-bg-secondary)'}">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center w-full px-4 py-3">
        <span class="text-lg font-semibold"
          [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Dashboard Data
          (Debug)</span>
      </div>
    </ng-template>
    <pre class="p-4 rounded-xl font-mono text-sm overflow-auto max-h-96"
      [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-secondary)'}">
      {{ { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales } | json }}
    </pre>
  </p-panel>

  <div *ngIf="isLoading" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
    <p-skeleton width="100%" height="8rem md:10rem" styleClass="mb-4 rounded-2xl"></p-skeleton>
    <p-skeleton width="100%" height="8rem md:10rem" styleClass="mb-4 rounded-2xl"></p-skeleton>
    <p-skeleton width="100%" height="8rem md:10rem" styleClass="mb-4 rounded-2xl"></p-skeleton>
    <p-skeleton width="100%" height="8rem md:10rem" styleClass="mb-4 rounded-2xl"></p-skeleton>
    <p-skeleton width="100%" height="16rem md:20rem"
      styleClass="mb-4 rounded-2xl col-span-1 sm:col-span-2 md:col-span-4"></p-skeleton>
    <p-skeleton width="100%" height="16rem md:20rem"
      styleClass="mb-4 rounded-2xl col-span-1 sm:col-span-2 md:col-span-4"></p-skeleton>
  </div>

  <gridstack [options]="gridOptions" *ngIf="!isLoading" class="relative">
    <gridstack-item *ngFor="let widget of widgets; trackBy: identify" [options]="widget">
      <p-panel [header]="widget.content ?? 'Unknown Widget'"
        styleClass="h-full shadow-md rounded-2xl hover:shadow-lg transition-all duration-300"
        [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(20px)'}" [@panelAnimation]>
        <ng-template pTemplate="header">
          <div class="flex justify-between items-center w-full px-3 py-2 md:px-4 md:py-3">
            <span class="text-lg md:text-xl font-semibold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ widget.content
              ?? 'Unknown Widget' }}</span>
            <div class="flex gap-1 md:gap-2">
              <button pButton icon="pi pi-refresh" class="p-button-text p-button-sm p-button-rounded"
                [style]="{'color': 'var(--theme-text-secondary)'}" (click)="refreshWidget(widget.id ?? '')"></button>
              <button pButton icon="pi pi-window-maximize" class="p-button-text p-button-sm p-button-rounded"
                [style]="{'color': 'var(--theme-text-secondary)'}"
                (click)="openDialog(widget.content ?? 'Unknown Widget', { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales })"></button>
            </div>
          </div>
        </ng-template>
        <p-message *ngIf="widget.id && error[widget.id]" severity="error" class="mb-4 rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}"></p-message>

        <!-- KPI Summary Widget -->
        <ng-container *ngIf="widget.id === 'kpiSummary' && !error['kpiSummary']">
          <div class="p-4 md:p-6 space-y-4 md:space-y-6" *ngIf="!isKpiLoading; else kpiLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-pink-100 to-pink-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-pink-200">
                  <i class="pi pi-money-bill text-pink-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Revenue
                </h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
                  enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-xs mt-1"
                  [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Change: {{
                  enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
              </div>
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-blue-100 to-blue-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-200">
                  <i class="pi pi-wallet text-blue-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Gross Profit
                </h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
                  enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-xs mt-1"
                  [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Margin: {{
                  kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
              </div>
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-purple-100 to-purple-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-purple-200">
                  <i class="pi pi-shopping-cart text-purple-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Sales</h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
                  enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
                <p class="text-xs mt-1"
                  [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Avg. Order: ${{
                  kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-green-100 to-green-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-green-200">
                  <i class="pi pi-users text-green-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers
                </h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
                  enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
                <p class="text-xs mt-1"
                  [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">LTV: ${{
                  enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
              </div>
            </div>
            <div class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Trend
              </h3>
              <ngx-charts-line-chart [results]="revenueTrendData" [view]="[600, revenueTrendData.length * 50 || 200]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}"></ngx-charts-line-chart>
            </div>
            <div class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Selling
                Products</h3>
              <p-table [value]="overview?.topSellingProducts" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Quantity</th>
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-2 md:p-3"><img [src]="product.thumbnail" alt="product"
                        class="w-8 h-8 md:w-10 md:h-10 object-cover rounded"></td>
                    <td class="p-2 md:p-3 text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">{{
                      product.productName }}</td>
                    <td class="p-2 md:p-3 text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">{{
                      product.totalQuantity }}</td>
                    <td class="p-2 md:p-3 text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">${{
                      product.totalRevenue?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
          <ng-template #kpiLoading>
            <div class="p-4 md:p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-4 md:mb-6">
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="12rem md:14rem" styleClass="rounded-2xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Charts Overview Widget -->
        <ng-container *ngIf="widget.id === 'chartsOverview' && !error['chartsOverview']">
          <div class="p-4 md:p-6" *ngIf="!isChartsLoading; else chartsLoading">
            <p-message severity="info" text="Charts data not yet available. Please provide API response data."
              class="rounded-2xl"
              [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}"></p-message>
          </div>
          <ng-template #chartsLoading>
            <div class="p-4 md:p-6">
              <p-skeleton width="100%" height="18rem md:22rem" styleClass="rounded-2xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Product Analytics Widget -->
        <ng-container *ngIf="widget.id === 'productAnalytics' && !error['productAnalytics']">
          <div class="p-4 md:p-6 space-y-4 md:space-y-6" *ngIf="!isProductLoading; else productLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-blue-100 to-blue-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-200">
                  <i class="pi pi-box text-blue-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Inventory
                  Value</h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
                  productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-green-100 to-green-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-green-200">
                  <i class="pi pi-database text-green-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Items in Stock
                </h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
                  productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
              </div>
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-yellow-100 to-yellow-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-yellow-200">
                  <i class="pi pi-exclamation-triangle text-yellow-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Low Stock</h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
                  productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
              </div>
            </div>
            <div class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Performance by
                Category</h3>
              <ngx-charts-bar-vertical [results]="categoryData" [view]="[600, categoryData.length * 60 || 300]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}"></ngx-charts-bar-vertical>
            </div>
            <div class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Products by
                Revenue</h3>
              <p-table [value]="productAnalytics?.topPerformingProducts?.topByRevenue" [responsive]="true"
                [tableStyle]="{'min-width': '100%'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Brand</th>
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Profit</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-2 md:p-3"><img [src]="product.thumbnail" alt="product"
                        class="w-8 h-8 md:w-10 md:h-10 object-cover rounded"></td>
                    <td class="p-2 md:p-3 text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">{{
                      product.title }}</td>
                    <td class="p-2 md:p-3 text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">{{
                      product.brand }}</td>
                    <td class="p-2 md:p-3 text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">${{
                      product.totalRevenue?.toLocaleString() }}</td>
                    <td class="p-2 md:p-3 text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">${{
                      product.grossProfit?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Inventory
                Turnover</h3>
              <p-message severity="info"
                text="Inventory turnover data not yet available. Please provide API response data." class="rounded-2xl"
                [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}"></p-message>
            </div>
          </div>
          <ng-template #productLoading>
            <div class="p-4 md:p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 mb-4 md:mb-6">
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="18rem md:22rem" styleClass="rounded-2xl mb-4 md:mb-6"></p-skeleton>
              <p-skeleton width="100%" height="12rem md:14rem" styleClass="rounded-2xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Customer Analytics Widget -->
        <ng-container *ngIf="widget.id === 'customerAnalytics' && !error['customerAnalytics']">
          <div class="p-4 md:p-6 space-y-4 md:space-y-6" *ngIf="!isCustomerLoading; else customerLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6">
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-purple-100 to-purple-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-purple-200">
                  <i class="pi pi-user-plus text-purple-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers
                </h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
                  customerAnalytics?.summary?.newCustomers || 0 }}</p>
                <p class="text-xs mt-1"
                  [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
              </div>
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-blue-100 to-blue-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-200">
                  <i class="pi pi-refresh text-blue-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Repeat Customer
                  Rate</h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
                  customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
                <p class="text-xs mt-1"
                  [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Retention rate
                </p>
              </div>
            </div>
            <div class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Customers by
                Lifetime Value</h3>
              <p-table [value]="customerAnalytics?.topCustomersLifetime" [responsive]="true"
                [tableStyle]="{'min-width': '100%'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Name</th>
                    <th class="text-left p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Email</th>
                    <th class="text-right p-2 md:p-3 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Lifetime Value
                    </th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-customer>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-2 md:p-3 font-medium text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">
                      {{ customer.fullname }}</td>
                    <td class="p-2 md:p-3 text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">{{
                      customer.email }}</td>
                    <td class="p-2 md:p-3 text-right text-xs md:text-sm" [style]="{'font-family': 'var(--font-body)'}">
                      ${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="3" class="text-center py-3 md:py-4 text-xs md:text-sm"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">No customer
                      data available</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Breakdown
              </h3>
              <p-message *ngIf="!customerAnalytics?.revenueBreakdown?.length" severity="info"
                text="Revenue breakdown data not available for this period." class="rounded-2xl"
                [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}"></p-message>
            </div>
          </div>
          <ng-template #customerLoading>
            <div class="p-4 md:p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="14rem md:18rem" styleClass="rounded-2xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Payment Analytics Widget -->
        <ng-container *ngIf="widget.id === 'paymentAnalytics' && !error['paymentAnalytics']">
          <div class="p-4 md:p-6 space-y-4 md:space-y-6" *ngIf="!isPaymentLoading; else paymentLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-pink-100 to-pink-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-pink-200">
                  <i class="pi pi-money-bill text-pink-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Billed
                </h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
                  paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
                <p class="text-xs mt-1"
                  [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
              </div>
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-green-100 to-green-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-green-200">
                  <i class="pi pi-wallet text-green-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Collected
                </h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
                  paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
                <p class="text-xs mt-1"
                  [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Collections</p>
              </div>
              <div
                class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 bg-gradient-to-br from-blue-100 to-blue-50">
                <div class="flex items-center justify-center mb-2 w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-200">
                  <i class="pi pi-percentage text-blue-600 text-lg md:text-xl"></i>
                </div>
                <h3 class="text-xs md:text-sm font-medium mb-1 md:mb-2"
                  [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Collection Rate
                </h3>
                <p class="text-2xl md:text-3xl font-bold"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
                  paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
                <p class="text-xs mt-1"
                  [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Success rate</p>
              </div>
            </div>
            <div
              class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300 grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <div class="col-span-1">
                <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Status
                </h3>
                <div class="flex items-center gap-3 md:gap-4">
                  <div class="p-3 md:p-4 rounded-2xl flex-1 bg-gradient-to-br from-red-100 to-red-50">
                    <p class="text-xs md:text-sm font-medium"
                      [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed
                      Payments</p>
                    <p class="text-xl md:text-2xl font-bold"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
                      paymentAnalytics?.failedPayments?.count || 0 }}</p>
                  </div>
                  <div class="p-3 md:p-4 rounded-2xl flex-1 bg-gradient-to-br from-red-100 to-red-50">
                    <p class="text-xs md:text-sm font-medium"
                      [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Value
                    </p>
                    <p class="text-xl md:text-2xl font-bold"
                      [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
                      (paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Methods
                Breakdown</h3>
              <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[350, paymentMethodsData.length * 50 || 200]"
                [scheme]="paymentColorScheme" [doughnut]="true" [arcWidth]="0.3" [labels]="true" [gradient]="true"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}"></ngx-charts-pie-chart>
            </div>
            <div class="p-3 md:p-5 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-md md:text-lg font-semibold mb-2 md:mb-3"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Collection Trends
              </h3>
              <ngx-charts-line-chart [results]="collectionTrendsData"
                [view]="[600, collectionTrendsData.length * 50 || 200]" [xAxis]="showXAxis" [yAxis]="showYAxis"
                xAxisLabel="Date" yAxisLabel="Collection Amount ($)" [showXAxisLabel]="showXAxisLabel"
                [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme" class="w-full"
                [style]="{'fill': 'var(--theme-accent-primary)'}"></ngx-charts-line-chart>
            </div>
          </div>
          <ng-template #paymentLoading>
            <div class="p-4 md:p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 mb-4 md:mb-6">
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
                <p-skeleton width="100%" height="6rem md:8rem" styleClass="rounded-2xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="18rem md:22rem" styleClass="rounded-2xl mb-4 md:mb-6"></p-skeleton>
              <p-skeleton width="100%" height="12rem md:14rem" styleClass="rounded-2xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        <!-- Sales Forecast Widget -->
        <ng-container *ngIf="widget.id === 'salesForecast' && !error['salesForecast']">
          <div class="p-4 md:p-6" *ngIf="!isForecastLoading; else forecastLoading">
            <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data."
              class="rounded-2xl"
              [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}"></p-message>
          </div>
          <ng-template #forecastLoading>
            <div class="p-4 md:p-6">
              <p-skeleton width="100%" height="18rem md:22rem" styleClass="rounded-2xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>
      </p-panel>
    </gridstack-item>
  </gridstack>

  <p-dialog [header]="selectedPanelTitle" [(visible)]="showDialog" [modal]="true"
    styleClass="w-full max-w-[90vw] md:max-w-9xl shadow-lg rounded-2xl"
    [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(20px)'}" [draggable]="false"
    [resizable]="true">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center w-full px-3 py-2 md:px-4 md:py-3">
        <span class="text-lg md:text-xl font-semibold"
          [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelTitle
          }}</span>
      </div>
    </ng-template>
    <ng-container *ngIf="selectedPanelTitle === 'KPI Summary' && !error['kpiSummary']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Revenue</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm mt-1"
              [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Change: {{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Gross Profit</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm mt-1"
              [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Margin: {{
              selectedPanelData?.kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Sales</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
            <p class="text-sm mt-1"
              [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Avg. Order: ${{
              selectedPanelData?.kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
              selectedPanelData?.enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
            <p class="text-sm mt-1"
              [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">LTV: ${{
              selectedPanelData?.enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Trend</h3>
          <ngx-charts-line-chart [results]="revenueTrendData" [view]="[800, revenueTrendData.length * 60 || 300]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}"></ngx-charts-line-chart>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Selling Products
          </h3>
          <p-table [value]="selectedPanelData?.overview?.topSellingProducts" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Quantity</th>
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded">
                </td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.productName }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.totalQuantity }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString()
                  }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Charts Overview' && !error['chartsOverview']">
      <div class="p-6">
        <p-message severity="info" text="Charts data not yet available. Please provide API response data."
          class="rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}"></p-message>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Product Analytics' && !error['productAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Inventory
              Value</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
              selectedPanelData?.productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Items in Stock</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
              selectedPanelData?.productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Low Stock</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
              selectedPanelData?.productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Performance by
            Category</h3>
          <ngx-charts-bar-vertical [results]="categoryData" [view]="[800, categoryData.length * 60 || 400]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}"></ngx-charts-bar-vertical>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Products by
            Revenue</h3>
          <p-table [value]="selectedPanelData?.productAnalytics?.topPerformingProducts?.topByRevenue"
            [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Brand</th>
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Profit</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded">
                </td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.title }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.brand }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString()
                  }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.grossProfit?.toLocaleString()
                  }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Inventory Turnover
          </h3>
          <p-message severity="info" text="Inventory turnover data not yet available. Please provide API response data."
            class="rounded-xl"
            [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}"></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Customer Analytics' && !error['customerAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
              selectedPanelData?.customerAnalytics?.summary?.newCustomers || 0 }}</p>
            <p class="text-sm mt-1"
              [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Repeat Customer Rate
            </h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
              selectedPanelData?.customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
            <p class="text-sm mt-1"
              [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Retention rate</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Customers by
            Lifetime Value</h3>
          <p-table [value]="selectedPanelData?.customerAnalytics?.topCustomersLifetime"
            [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Name</th>
                <th class="text-left p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Email</th>
                <th class="text-right p-3"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Lifetime Value
                </th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-customer>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3 font-medium" [style]="{'font-family': 'var(--font-body)'}">{{ customer.fullname }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ customer.email }}</td>
                <td class="p-3 text-right" [style]="{'font-family': 'var(--font-body)'}">${{
                  customer.lifetimeValue?.toLocaleString() || '0' }}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3" class="text-center py-4"
                  [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">No customer data
                  available</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Breakdown
          </h3>
          <p-message *ngIf="!selectedPanelData?.customerAnalytics?.revenueBreakdown?.length" severity="info"
            text="Revenue breakdown data not available for this period." class="rounded-xl"
            [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}"></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Payment Analytics' && !error['paymentAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Billed</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
              selectedPanelData?.paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
            <p class="text-sm mt-1"
              [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Collected</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
              selectedPanelData?.paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
            <p class="text-sm mt-1"
              [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Collections</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2"
              [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Collection Rate</h3>
            <p class="text-3xl font-bold"
              [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
              selectedPanelData?.paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
            <p class="text-sm mt-1"
              [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Success rate</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Status</h3>
          <div class="flex items-center gap-4">
            <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
              <p class="text-sm font-medium"
                [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Payments
              </p>
              <p class="text-2xl font-bold"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{
                selectedPanelData?.paymentAnalytics?.failedPayments?.count || 0 }}</p>
            </div>
            <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
              <p class="text-sm font-medium"
                [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Value</p>
              <p class="text-2xl font-bold"
                [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{
                (selectedPanelData?.paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
            </div>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Methods
            Breakdown</h3>
          <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[600, paymentMethodsData.length * 50 || 300]"
            [scheme]="paymentColorScheme" [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}"></ngx-charts-pie-chart>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3"
            [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Collection Trends
          </h3>
          <ngx-charts-line-chart [results]="collectionTrendsData"
            [view]="[800, collectionTrendsData.length * 60 || 300]" [xAxis]="showXAxis" [yAxis]="showYAxis"
            xAxisLabel="Date" yAxisLabel="Collection Amount ($)" [showXAxisLabel]="showXAxisLabel"
            [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme" class="w-full"
            [style]="{'fill': 'var(--theme-accent-primary)'}"></ngx-charts-line-chart>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Sales Forecast' && !error['salesForecast']">
      <div class="p-6">
        <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data."
          class="rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}"></p-message>
      </div>
    </ng-container>
  </p-dialog>
</div>


<!-- <p-toast position="top-right"></p-toast>
<div class="admin-dashboard min-h-screen p-6" [style]="{'background': 'var(--theme-bg-primary)'}" [@fadeIn]="true">
  <p-toolbar styleClass="sticky top-0 z-20 shadow-lg rounded-xl mb-6 se-filter-bar" [style]="{'background': 'var(--theme-bg-secondary)'}">
    <div class="p-toolbar-group-left">
      <h2 class="text-2xl font-bold tracking-tight" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Admin Dashboard</h2>
    </div>
    <div class="p-toolbar-group-center flex flex-wrap gap-4 items-center">
      <p-select [options]="periodOptions" [(ngModel)]="selectedPeriod" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-48 rounded-xl" [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" (onChange)="onFilterChange()"></p-select>
      <p-select [options]="limitOptions" [(ngModel)]="dataLimit" optionLabel="label" optionValue="value"
        styleClass="p-inputtext-sm w-36 rounded-xl" [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" (onChange)="onFilterChange()"></p-select>
      <div *ngIf="selectedPeriod === 'custom'" class="flex gap-3 items-center">
        <p-calendar [(ngModel)]="customDateRange" selectionMode="range" [readonlyInput]="true"
          placeholder="Select Date Range" dateFormat="dd/mm/yy"
          styleClass="p-inputtext-sm w-72 rounded-xl" [style]="{'background': 'var(--theme-bg-ternary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" ></p-calendar>
        <button pButton type="button" label="Apply" icon="pi pi-check" class="p-button-sm rounded-xl"
          [style]="{'background': 'var(--theme-accent-primary)', 'color': 'var(--theme-accent-text-color)', 'border': 'none'}" (click)="onApplyCustomRange()"></button>
      </div>
      <p-progressSpinner *ngIf="isLoading" styleClass="w-6 h-6" strokeWidth="4"></p-progressSpinner>
    </div>
    <div class="p-toolbar-group-right flex gap-3">
      <button pButton pRipple type="button" [icon]="isGridLocked ? 'pi pi-lock' : 'pi pi-lock-open'"
        [label]="isGridLocked ? 'Unlock Grid' : 'Lock Grid'" class="p-button-outlined p-button-sm rounded-xl"
        [style]="{'border-color': 'var(--theme-border-primary)', 'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}" (click)="toggleLockGrid()"></button>
      <button pButton type="button" icon="pi pi-save" label="Save Layout" class="p-button-sm rounded-xl"
        [style]="{'background': 'var(--theme-accent-primary)', 'color': 'var(--theme-accent-text-color)', 'border': 'none', 'font-family': 'var(--font-body)'}" (click)="saveLayout()"></button>
      <button pButton type="button" icon="pi pi-refresh" label="Reload All" class="p-button-sm rounded-xl"
        [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)', 'border-color': 'var(--theme-border-secondary)', 'font-family': 'var(--font-body)'}" (click)="triggerRefresh()"></button>
      <button pButton type="button" icon="pi pi-code" label="Toggle JSON" class="p-button-sm p-button-outlined rounded-xl"
        [style]="{'border-color': 'var(--theme-border-primary)', 'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}" (click)="showJson = !showJson"></button>
    </div>
  </p-toolbar>

  <p-panel *ngIf="showJson" header="Dashboard Data (Debug)" styleClass="mb-6 shadow-lg rounded-xl"
    [style]="{'background': 'var(--theme-bg-secondary)'}">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center w-full px-4 py-2">
        <span class="text-xl font-semibold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Dashboard Data (Debug)</span>
      </div>
    </ng-template>
    <pre class="p-4 rounded-xl font-mono text-sm overflow-auto"
      [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-secondary)'}">
      {{ { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales } | json }}
    </pre>
  </p-panel>

  <div *ngIf="isLoading" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <p-skeleton width="100%" height="12rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
    <p-skeleton width="100%" height="20rem" styleClass="mb-6 rounded-xl"></p-skeleton>
  </div>

  <gridstack [options]="gridOptions" *ngIf="!isLoading" class="relative">
    <gridstack-item *ngFor="let widget of widgets; trackBy: identify" [options]="widget">
      <p-panel [header]="widget.content ?? 'Unknown Widget'"
        styleClass="h-full shadow-lg rounded-xl hover:shadow-xl transition-shadow duration-300"
        [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}" [@panelAnimation]>
        <ng-template pTemplate="header">
          <div class="flex justify-between items-center w-full px-4 py-2">
            <span class="text-xl font-semibold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ widget.content ?? 'Unknown Widget' }}</span>
            <div class="flex gap-2">
              <button pButton icon="pi pi-refresh" class="p-button-text p-button-sm"
                [style]="{'color': 'var(--theme-text-secondary)'}" (click)="refreshWidget(widget.id ?? '')"></button>
              <button pButton icon="pi pi-window-maximize" class="p-button-text p-button-sm"
                [style]="{'color': 'var(--theme-text-secondary)'}" (click)="openDialog(widget.content ?? 'Unknown Widget', { enhancedKpiSummary, kpiSummary, overview, productAnalytics, customerAnalytics, paymentAnalytics, inventoryTurnover, salesForecast, salesTrends, salesCharts, yearlySales, monthlySales, weeklySales })"></button>
            </div>
          </div>
        </ng-template>
        <p-message *ngIf="widget.id && error[widget.id]" severity="error" class="mb-4 rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>

        KPI Summary Widget
        <ng-container *ngIf="widget.id === 'kpiSummary' && !error['kpiSummary']">
          <div class="p-6 space-y-6" *ngIf="!isKpiLoading; else kpiLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Revenue</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Change: {{ enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Gross Profit</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Margin: {{ kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Sales</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Avg. Order: ${{ kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">LTV: ${{ enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Trend</h3>
              <ngx-charts-line-chart [results]="revenueTrendData" [view]="[600, revenueTrendData.length * 50 || 200]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Selling Products</h3>
              <p-table [value]="overview?.topSellingProducts" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Quantity</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.productName }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.totalQuantity }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
          <ng-template #kpiLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Charts Overview Widget
        <ng-container *ngIf="widget.id === 'chartsOverview' && !error['chartsOverview']">
          <div class="p-6" *ngIf="!isChartsLoading; else chartsLoading">
            <p-message severity="info" text="Charts data not yet available. Please provide API response data." class="rounded-xl"
              [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
          </div>
          <ng-template #chartsLoading>
            <div class="p-6">
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Product Analytics Widget
        <ng-container *ngIf="widget.id === 'productAnalytics' && !error['productAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isProductLoading; else productLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Inventory Value</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Items in Stock</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Low Stock</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Performance by Category</h3>
              <ngx-charts-bar-vertical [results]="categoryData" [view]="[600, categoryData.length * 60 || 300]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-bar-vertical>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Products by Revenue</h3>
              <p-table [value]="productAnalytics?.topPerformingProducts?.topByRevenue" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Brand</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Profit</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.title }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.brand }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.grossProfit?.toLocaleString() }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Inventory Turnover</h3>
              <p-message severity="info" text="Inventory turnover data not yet available. Please provide API response data." class="rounded-xl"
                [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
            </div>
          </div>
          <ng-template #productLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl mb-6"></p-skeleton>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Customer Analytics Widget
        <ng-container *ngIf="widget.id === 'customerAnalytics' && !error['customerAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isCustomerLoading; else customerLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ customerAnalytics?.summary?.newCustomers || 0 }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Repeat Customer Rate</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Retention rate</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Customers by Lifetime Value</h3>
              <p-table [value]="customerAnalytics?.topCustomersLifetime" [tableStyle]="{'min-width': '40rem'}">
                <ng-template pTemplate="header">
                  <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Name</th>
                    <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Email</th>
                    <th class="text-right p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Lifetime Value</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-customer>
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                    <td class="p-3 font-medium" [style]="{'font-family': 'var(--font-body)'}">{{ customer.fullname }}</td>
                    <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ customer.email }}</td>
                    <td class="p-3 text-right" [style]="{'font-family': 'var(--font-body)'}">${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="3" class="text-center py-4" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">No customer data available</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Breakdown</h3>
              <p-message *ngIf="!customerAnalytics?.revenueBreakdown?.length" severity="info"
                text="Revenue breakdown data not available for this period." class="rounded-xl"
                [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
            </div>
          </div>
          <ng-template #customerLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="18rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Payment Analytics Widget
        <ng-container *ngIf="widget.id === 'paymentAnalytics' && !error['paymentAnalytics']">
          <div class="p-6 space-y-6" *ngIf="!isPaymentLoading; else paymentLoading">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Billed</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Collected</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Collections</p>
              </div>
              <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
                <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Collection Rate</h3>
                <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
                <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Success rate</p>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Status</h3>
              <div class="flex items-center gap-4">
                <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
                  <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Payments</p>
                  <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ paymentAnalytics?.failedPayments?.count || 0 }}</p>
                </div>
                <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
                  <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Value</p>
                  <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ (paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
                </div>
              </div>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Methods Breakdown</h3>
              <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[400, paymentMethodsData.length * 50 || 250]"
                [scheme]="paymentColorScheme" [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-pie-chart>
            </div>
            <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
              [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
              <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Collection Trends</h3>
              <ngx-charts-line-chart [results]="collectionTrendsData" [view]="[600, collectionTrendsData.length * 50 || 200]"
                [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Collection Amount ($)"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
                class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
            </div>
          </div>
          <ng-template #paymentLoading>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
                <p-skeleton width="100%" height="8rem" styleClass="rounded-xl"></p-skeleton>
              </div>
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl mb-6"></p-skeleton>
              <p-skeleton width="100%" height="14rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>

        Sales Forecast Widget
        <ng-container *ngIf="widget.id === 'salesForecast' && !error['salesForecast']">
          <div class="p-6" *ngIf="!isForecastLoading; else forecastLoading">
            <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data." class="rounded-xl"
              [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
          </div>
          <ng-template #forecastLoading>
            <div class="p-6">
              <p-skeleton width="100%" height="22rem" styleClass="rounded-xl"></p-skeleton>
            </div>
          </ng-template>
        </ng-container>
      </p-panel>
    </gridstack-item>
  </gridstack>

  <p-dialog [header]="selectedPanelTitle" [(visible)]="showDialog" [modal]="true" styleClass="w-full max-w-7xl shadow-lg rounded-xl"
    [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}" [draggable]="false">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center w-full px-4 py-2">
        <span class="text-xl font-semibold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelTitle }}</span>
      </div>
    </ng-template>
    <ng-container *ngIf="selectedPanelTitle === 'KPI Summary' && !error['kpiSummary']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Revenue</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Change: {{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalRevenue?.change || 0 }}%</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Gross Profit</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.grossProfit?.value?.toLocaleString() || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Margin: {{ selectedPanelData?.kpiSummary?.salesSummary?.profitMargin?.toFixed(2) || 'N/A' }}%</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Sales</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.totalSales?.value || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Avg. Order: ${{ selectedPanelData?.kpiSummary?.salesSummary?.averageOrderValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.enhancedKpiSummary?.kpiSummary?.newCustomers?.value || 'N/A' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">LTV: ${{ selectedPanelData?.enhancedKpiSummary?.customerInsights?.lifetimeValue?.toLocaleString() || 'N/A' }}</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Trend</h3>
          <ngx-charts-line-chart [results]="revenueTrendData" [view]="[800, revenueTrendData.length * 60 || 300]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Selling Products</h3>
          <p-table [value]="selectedPanelData?.overview?.topSellingProducts" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Quantity</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.productName }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.totalQuantity }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Charts Overview' && !error['chartsOverview']">
      <div class="p-6">
        <p-message severity="info" text="Charts data not yet available. Please provide API response data." class="rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Product Analytics' && !error['productAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Inventory Value</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.productAnalytics?.inventorySummary?.totalValue?.toLocaleString() || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Items in Stock</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.productAnalytics?.inventorySummary?.totalItems || 'N/A' }}</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Low Stock</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.productAnalytics?.inventorySummary?.lowStockCount || 'N/A' }}</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Performance by Category</h3>
          <ngx-charts-bar-vertical [results]="categoryData" [view]="[800, categoryData.length * 60 || 400]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Category" yAxisLabel="Revenue ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="categoryColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-bar-vertical>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Products by Revenue</h3>
          <p-table [value]="selectedPanelData?.productAnalytics?.topPerformingProducts?.topByRevenue" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Image</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Product</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Brand</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Revenue</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Profit</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3"><img [src]="product.thumbnail" alt="product" class="w-10 h-10 object-cover rounded"></td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.title }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ product.brand }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.totalRevenue?.toLocaleString() }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">${{ product.grossProfit?.toLocaleString() }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Inventory Turnover</h3>
          <p-message severity="info" text="Inventory turnover data not yet available. Please provide API response data." class="rounded-xl"
            [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Customer Analytics' && !error['customerAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">New Customers</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.customerAnalytics?.summary?.newCustomers || 0 }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Repeat Customer Rate</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.customerAnalytics?.summary?.repeatCustomerRate * 100 || 0 }}%</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Retention rate</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Top Customers by Lifetime Value</h3>
          <p-table [value]="selectedPanelData?.customerAnalytics?.topCustomersLifetime" [tableStyle]="{'min-width': '40rem'}">
            <ng-template pTemplate="header">
              <tr [style]="{'background': 'var(--theme-bg-ternary)'}">
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Name</th>
                <th class="text-left p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Email</th>
                <th class="text-right p-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">Lifetime Value</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-customer>
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                [style]="{'background': 'var(--theme-bg-primary)', 'color': 'var(--theme-text-primary)'}">
                <td class="p-3 font-medium" [style]="{'font-family': 'var(--font-body)'}">{{ customer.fullname }}</td>
                <td class="p-3" [style]="{'font-family': 'var(--font-body)'}">{{ customer.email }}</td>
                <td class="p-3 text-right" [style]="{'font-family': 'var(--font-body)'}">${{ customer.lifetimeValue?.toLocaleString() || '0' }}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3" class="text-center py-4" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-body)'}">No customer data available</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Revenue Breakdown</h3>
          <p-message *ngIf="!selectedPanelData?.customerAnalytics?.revenueBreakdown?.length" severity="info"
            text="Revenue breakdown data not available for this period." class="rounded-xl"
            [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Payment Analytics' && !error['paymentAnalytics']">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Billed</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.paymentAnalytics?.financialHealth?.totalBilled?.toLocaleString() || '0' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">This period</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Total Collected</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ selectedPanelData?.paymentAnalytics?.financialHealth?.totalCollected?.toLocaleString() || '0' }}</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Collections</p>
          </div>
          <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
            [style]="{'background': 'var(--theme-accent-primary-light)', 'backdrop-filter': 'blur(10px)'}">
            <h3 class="text-sm font-medium mb-2" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Collection Rate</h3>
            <p class="text-3xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.paymentAnalytics?.financialHealth?.collectionRate?.toFixed(1) || '0' }}%</p>
            <p class="text-sm mt-1" [style]="{'color': 'var(--theme-text-secondary)', 'font-family': 'var(--font-body)'}">Success rate</p>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Status</h3>
          <div class="flex items-center gap-4">
            <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
              <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Payments</p>
              <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">{{ selectedPanelData?.paymentAnalytics?.failedPayments?.count || 0 }}</p>
            </div>
            <div class="p-4 rounded-xl flex-1" [style]="{'background': 'var(--theme-accent-primary-light)'}">
              <p class="text-sm font-medium" [style]="{'color': 'var(--theme-accent-primary)', 'font-family': 'var(--font-body)'}">Failed Value</p>
              <p class="text-2xl font-bold" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">${{ (selectedPanelData?.paymentAnalytics?.failedPayments?.totalValue || 0)?.toLocaleString() }}</p>
            </div>
          </div>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Payment Methods Breakdown</h3>
          <ngx-charts-pie-chart [results]="paymentMethodsData" [view]="[600, paymentMethodsData.length * 50 || 300]"
            [scheme]="paymentColorScheme" [doughnut]="false" [arcWidth]="0.25" [labels]="true" [gradient]="false"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-pie-chart>
        </div>
        <div class="p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300"
          [style]="{'background': 'var(--theme-bg-secondary)', 'backdrop-filter': 'blur(10px)'}">
          <h3 class="text-lg font-semibold mb-3" [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">Collection Trends</h3>
          <ngx-charts-line-chart [results]="collectionTrendsData" [view]="[800, collectionTrendsData.length * 60 || 300]"
            [xAxis]="showXAxis" [yAxis]="showYAxis" xAxisLabel="Date" yAxisLabel="Collection Amount ($)"
            [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [scheme]="revenueColorScheme"
            class="w-full" [style]="{'fill': 'var(--theme-accent-primary)'}" ></ngx-charts-line-chart>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedPanelTitle === 'Sales Forecast' && !error['salesForecast']">
      <div class="p-6">
        <p-message severity="info" text="Sales forecast data not yet available. Please provide API response data." class="rounded-xl"
          [style]="{'background': 'var(--theme-bg-ternary)', 'color': 'var(--theme-text-primary)'}" ></p-message>
      </div>
    </ng-container>
  </p-dialog>
</div> -->