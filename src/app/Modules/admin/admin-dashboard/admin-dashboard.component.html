<div class="dashboard-container">
    <h1>Admin Dashboard</h1>

    <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
        {{ errorMessage }}
    </div>

    <div class="filters-bar card mb-4">
        <div class="card-body">
            <h5 class="card-title">Filters</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="periodSelect" class="form-label">Predefined Period:</label>
                    <select id="periodSelect" class="form-select" [(ngModel)]="selectedPeriod" (ngModelChange)="onPeriodChange($event)">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="customStartDate" class="form-label">Start Date:</label>
                    <input type="date" id="customStartDate" class="form-control" [(ngModel)]="customStartDate">
                </div>
                <div class="col-md-3">
                    <label for="customEndDate" class="form-label">End Date:</label>
                    <input type="date" id="customEndDate" class="form-control" [(ngModel)]="customEndDate">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" (click)="applyCustomDateRange()">Apply Custom Range & Reload</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h2>Overall Summary <span *ngIf="isLoadingSummary">(Loading...)</span></h2>
                </div>
                <div *ngIf="dashboardSummary && !isLoadingSummary" class="card-body">
                    <div class="row">
                        <div class="col-md-4 summary-stat">
                            <h4>Sales</h4>
                            <p>Total Revenue: {{ dashboardSummary.sales.totalRevenue | currency:'INR':'symbol' }}</p>
                            <p>Number of Sales: {{ dashboardSummary.sales.numberOfSales }}</p>
                            <p>Avg. Order Value: {{ dashboardSummary.sales.averageOrderValue | currency:'INR':'symbol' }}</p>
                        </div>
                        <div class="col-md-4 summary-stat">
                            <h4>Customers</h4>
                            <p>New (Period): {{ dashboardSummary.customers.newCustomersCount }}</p>
                            <p>With Dues: {{ dashboardSummary.customers.outstandingPayments.length }}</p>
                        </div>
                        <div class="col-md-4 summary-stat">
                            <h4>Payments</h4>
                            <p>Total Received: {{ dashboardSummary.payments.totalReceived | currency:'INR':'symbol' }}</p>
                        </div>
                    </div>
                    <hr>
                    <h5>Top Selling Products ({{dashboardSummary.products.topSelling.length}})</h5>
                    <ul class="list-group list-group-flush small">
                        <li *ngFor="let product of dashboardSummary.products.topSelling" class="list-group-item">
                            {{product.title}}: {{product.totalRevenue | currency:'INR'}} ({{product.totalQuantitySold}} units)
                        </li>
                        <li *ngIf="dashboardSummary.products.topSelling.length === 0" class="list-group-item">No top selling products found for this period.</li>
                    </ul>
                     <hr>
                    <h5>Low Stock Alerts ({{dashboardSummary.products.lowStock.length}})</h5>
                     <ul class="list-group list-group-flush small">
                        <li *ngFor="let product of dashboardSummary.products.lowStock" class="list-group-item">
                            {{product.title}} (SKU: {{product.sku}}): {{product.stock}} left
                        </li>
                         <li *ngIf="dashboardSummary.products.lowStock.length === 0" class="list-group-item">No low stock products.</li>
                    </ul>
                </div>
                <div *ngIf="!dashboardSummary && !isLoadingSummary" class="card-body">
                    <p>No summary data available for the selected period.</p>
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">Sales Trends (Last {{ salesTrends.length }} Days) <span *ngIf="isLoadingSalesTrends">(Loading...)</span></div>
                <div class="card-body">
                    <ul *ngIf="salesTrends.length > 0; else noSalesTrends">
                        <li *ngFor="let trend of salesTrends">
                            {{trend._id}}: {{trend.dailyRevenue | currency:'INR'}} ({{trend.dailySalesCount}} sales)
                        </li>
                    </ul>
                    <ng-template #noSalesTrends><p>No sales trend data available.</p></ng-template>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">Payments by Method</div>
                <div class="card-body">
                    <ul *ngIf="paymentsByMethod.length > 0; else noPaymentsMethod">
                        <li *ngFor="let method of paymentsByMethod">
                            {{method._id | titlecase}}: {{method.totalAmount | currency:'INR'}} ({{method.count}} transactions)
                        </li>
                    </ul>
                     <ng-template #noPaymentsMethod><p>No payment method data available.</p></ng-template>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">Recent Reviews (Top {{recentReviews.length}})</div>
                <div class="card-body">
                     <ul *ngIf="recentReviews.length > 0; else noRecentReviews" class="list-unstyled">
                        <li *ngFor="let review of recentReviews" class="mb-2 review-item">
                            <strong>{{review.product.title}}</strong> ({{review.rating}}/5) by {{review.user.fullname}}
                            <p class="small text-muted">"{{review.userreview | slice:0:100}}..."</p>
                            <span class="badge bg-secondary">{{review.createdAt | date:'short'}}</span>
                        </li>
                    </ul>
                    <ng-template #noRecentReviews><p>No recent reviews.</p></ng-template>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">Customers with Outstanding Payments (Top {{customersWithDues.length}})</div>
                <div class="card-body">
                    <ul *ngIf="customersWithDues.length > 0; else noCustomersWithDues">
                        <li *ngFor="let customer of customersWithDues">
                            {{customer.fullname}} ({{customer.email}}) - Due: {{customer.remainingAmount | currency:'INR'}}
                        </li>
                    </ul>
                    <ng-template #noCustomersWithDues><p>No customers with outstanding payments.</p></ng-template>
                </div>
            </div>
        </div>
    </div>

     </div>