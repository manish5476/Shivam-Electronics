<p-dialog header="Create EMI Plan" [(visible)]="visible" (visibleChange)="visibleChange.emit($event)" [modal]="true"
  [style]="{ width: '98vw', height: '95vh', maxWidth: '1200px' }" [closable]="true" [closeOnEscape]="true"
  appendTo="body">
  <div class="text-xs text-gray-500 mt-2">
    Debug: InvoiceId={{ invoiceId }}, Loaded={{ !!invoice() }}, Out={{ outstanding() }}, Rem={{ remainingAfterDown() }},
    EMI={{ emiAmount() | currency:'INR':'symbol':'1.2-2' }}, CanCreate={{ canCreate() }}
  </div>

  @if (loading()) {
  <div class="flex flex-col items-center justify-center h-full text-center">
    <i class="pi pi-spin pi-spinner text-5xl text-primary mb-4"></i>
    <p class="text-base text-gray-600">Fetching invoice details...</p>
  </div>
  } @else if (invoice()) {

  <div class="flex flex-col gap-5 p-6 overflow-y-auto max-h-[75vh] custom-scrollbar">

    <!-- Invoice Header -->
    <div
      class="p-5 bg-gradient-to-r from-indigo-500/10 via-blue-50 to-indigo-100 rounded-2xl border border-blue-200 shadow-sm">
      <div class="flex justify-between flex-wrap gap-3 items-start">
        <div>
          <p class="text-xs text-gray-500 mb-1">Invoice</p>
          <h2 class="font-bold text-2xl text-blue-900">#{{ invoice()?.invoiceNumber }}</h2>
        </div>
        <div class="text-right">
          <p class="text-xs text-gray-500 mb-1">Customer</p>
          <h3 class="font-semibold text-lg text-blue-800">{{ invoice()?.buyerDetails?.fullname }}</h3>
          <p class="text-sm text-gray-600">Phone {{ invoice()?.buyerDetails?.phoneNumbers[0].number || 'N/A' }}</p>
          <p class="text-sm text-gray-500">Email {{ invoice()?.buyerDetails?.email || 'N/A' }}</p>
        </div>
      </div>
      <div class="mt-3 flex justify-between flex-wrap gap-2 text-sm text-gray-700">
        <div><span class="font-medium">Date:</span> <span class="ml-1">{{ invoice()?.invoiceDate | date: 'dd MMM yyyy'
            }}</span></div>
        <div><span class="font-medium">Due:</span> <span class="ml-1 text-red-600">{{ invoice()?.dueDate | date: 'dd MMM
            yyyy' }}</span></div>
      </div>
    </div>

    <!-- Items -->
    <div class="p-4 bg-white border rounded-xl shadow-sm">
      <div class="flex justify-between items-center mb-3">
        <span class="font-semibold text-gray-700">Items</span>
        <span class="text-sm text-gray-500">{{ invoice()?.items?.length }} total</span>
      </div>
      <div class="divide-y divide-gray-100">
        @for (item of invoice()?.items; track item._id) {
        <div class="flex justify-between py-2 text-sm">
          <span class="truncate max-w-[250px]">{{ item.customTitle }}</span>
          <span class="font-semibold">₹{{ item.amount | number: '1.0-0' }}</span>
        </div>
        }
      </div>
      <div class="pt-3 mt-2 border-t flex justify-between text-sm font-bold text-blue-800">
        <span>Grand Total</span>
        <span>₹{{ invoice()?.totalAmount | number: '1.0-0' }}</span>
      </div>
    </div>

    <!-- Outstanding -->
    <div
      class="p-4 bg-gradient-to-r from-orange-50 to-amber-100 border border-amber-300 rounded-xl shadow-sm flex justify-between flex-wrap items-center">
      <div>
        <p class="font-semibold text-amber-700">Outstanding Amount</p>
        <p class="text-2xl font-bold text-amber-800 mt-1">
          {{ outstanding() | currency: 'INR': 'symbol': '1.0-0' }}
        </p>
      </div>
      <p-tag *ngIf="invoice()?.status === 'unpaid'" value="UNPAID" severity="warning" [rounded]="true"></p-tag>
    </div>

    <!-- Inputs -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block font-semibold mb-2 text-gray-700 text-sm">Installments</label>
        <p-inputNumber [ngModel]="numberOfInstallments()" (ngModelChange)="numberOfInstallments.set($event)" [min]="1"
          [max]="36" [showButtons]="true" [buttonLayout]="'horizontal'" incrementButtonClass="p-button-success"
          decrementButtonClass="p-button-danger" styleClass="w-full">
        </p-inputNumber>
      </div>

      <div>
        <label class="block font-semibold mb-2 text-gray-700 text-sm">Down Payment</label>
        <p-inputNumber [ngModel]="downPayment()" (ngModelChange)="downPayment.set($event)" mode="currency"
          currency="INR" locale="en-IN" [min]="0" [max]="outstanding()" placeholder="₹0" styleClass="w-full">
        </p-inputNumber>
      </div>

      <div>
        <label class="block font-semibold mb-2 text-gray-700 text-sm">Start Date</label>
        <p-datepicker [ngModel]="startDate()" (ngModelChange)="startDate.set($event)" [showIcon]="true"
          [minDate]="today" styleClass="w-full">
        </p-datepicker>
      </div>
    </div>

    <!-- EMI Preview -->
    <div
      class="p-5 mt-4 bg-gradient-to-br from-teal-50 via-emerald-100 to-green-50 rounded-2xl border border-emerald-200 shadow-inner">
      <div class="text-sm font-semibold text-emerald-900 mb-3">EMI Schedule Preview</div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div>
          <p class="text-gray-600">Monthly EMI</p>
          <p class="text-2xl font-bold text-emerald-800">
            {{ emiAmount() | currency: 'INR': 'symbol': '1.2-2' }}
          </p>
        </div>
        <div>
          <p class="text-gray-600">Tenure</p>
          <p class="text-lg font-bold">{{ numberOfInstallments() }} months</p>
        </div>
        <div>
          <p class="text-gray-600">First Due</p>
          <p class="font-medium">{{ firstDueDate() | date: 'dd MMM yyyy' }}</p>
        </div>
        <div>
          <p class="text-gray-600">Total Payable</p>
          <p class="font-bold text-teal-700">
            {{ remainingAfterDown() | currency: 'INR': 'symbol': '1.0-0' }}
          </p>
        </div>
      </div>
    </div>
  </div>



  } @else {
  <div class="text-center p-10 text-gray-500">
    <i class="pi pi-exclamation-triangle text-4xl mb-3"></i>
    <p>No invoice selected.</p>
  </div>
  }
  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center px-4 py-2">
      <p-button label="Cancel" severity="secondary" (onClick)="close()" icon="pi pi-times"></p-button>
      <p-button label="Create EMI Plan" icon="pi pi-check" [loading]="creating()"
        [disabled]="!canCreate() || creating()" (onClick)="createEmi()" severity="success">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>