<p-toast></p-toast>

<div class="customer-dashboard">
  <!-- Header Section -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-title">
        <h1 class="breadcrumb">
          <span>Customers</span>
          <i class="pi pi-chevron-right mx-2 text-gray-400"></i>
          <span class="current-customer">{{ customer?.fullname }}</span>
          
        </h1>
        <p>Detailed customer profile and analytics of {{ customer?.email }} , {{ customer?.mobileNumber || 'N/A' }} , {{ customer?.phoneNumbers[0].number }} -{{ customer?.createdAt | date:'MMM dd, yyyy' }}</p>
      </div>
      <div class="header-actions">
        <p-select appendTo="body" [(ngModel)]="customerId" (onChange)="getCustomerDetail()"
          [options]="customerIDDropdown" optionLabel="fullname" optionValue="_id" placeholder="Select Customer"
          [filter]="true" filterBy="fullname" styleClass="w-48">
        </p-select>
        <p-button icon="pi pi-refresh" styleClass="p-button-text ml-2" (onClick)="getCustomerDetail()"
          pTooltip="Refresh" tooltipPosition="bottom"></p-button>
        <p-button icon="pi pi-pencil" styleClass="p-button-text ml-2" (click)="showCustomer=true" pTooltip="Edit"
          tooltipPosition="bottom"></p-button>
      </div>
    </div>
  </header>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <p-skeleton height="10rem" styleClass="rounded-xl"></p-skeleton> <!-- Slightly shorter skeletons -->
    <p-skeleton height="10rem" styleClass="rounded-xl"></p-skeleton>
    <p-skeleton height="10rem" styleClass="rounded-xl"></p-skeleton>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && customer" class="dashboard-content">
    <!-- Profile Hero -->
    <section class="profile-hero">
      <!-- Profile Info -->
      <div class="profile-card">
        <div class="flex items-center gap-3"> <!-- Smaller gap -->
          <p-avatar *ngIf="customer?.profileImg; else initialsAvatar" [image]="customer?.profileImg" shape="circle" size="xlarge" styleClass="flex-shrink-0"></p-avatar>
          <ng-template #initialsAvatar>
            <p-avatar [label]="commonMethod.getInitials(customer.fullname || '')" shape="circle" size="xlarge" styleClass="flex-shrink-0"></p-avatar>
          </ng-template>
          <div class="flex-grow">
            <h2>{{ customer?.fullname }}</h2>
            <div class="contact-details">
              <p>{{ customer?.email }}</p>
              <p>{{ customer?.mobileNumber || 'N/A' }}</p>
              <p-tag *ngIf="customer?.phoneNumbers?.length" [value]="customer?.phoneNumbers[0]?.number" severity="info" [rounded]="true"></p-tag> <!-- Tag for alt phone -->
            </div>
            <p-tag [value]="customer?.status" [severity]="getStatusSeverity(customer.status)" class="mt-1" [rounded]="true"></p-tag> <!-- Smaller margin -->
          </div>
        </div>
      </div>

      <!-- Financial Overview -->
      <div class="financial-card">
        <h3>
          <i class="pi pi-chart-line"></i> Financial Summary
        </h3>
        <div class="grid grid-cols-2 gap-3"> <!-- Smaller gap -->
          <div class="kpi-item">
            <span>Total Revenue</span>
            <div class="text-green-600">{{ commonMethod.formatCurrency(customer.totalPurchasedAmount) }}</div>
          </div>
          <div class="kpi-item">
            <span>Outstanding</span>
            <div [ngClass]="{'text-red-600': getTotalUnpaidAmount() > 0, 'text-gray-500': getTotalUnpaidAmount() === 0}">
              {{ commonMethod.formatCurrency(getTotalUnpaidAmount()) }}
            </div>
          </div>
        </div>
        <div class="mt-3"> <!-- Smaller margin -->
          <span>Payment Success Rate</span>
          <p-progressBar [value]="getPaymentSuccessRate()" mode="determinate" [showValue]="false"
            class="h-2 mt-1"></p-progressBar>
          <span>{{ getPaymentSuccessRate() }}%</span>
        </div>
      </div>
    </section>

    <!-- Cart and Payment Section - Two Columns in One Row -->
    <section class="cart-payment-section">
      <!-- Cart Items -->
      <div class="data-container">
        <h3>
          <i class="pi pi-shopping-bag"></i> Cart Items
          <p-badge [value]="customer.cart?.items?.length || 0" severity="info" class="ml-2" />
        </h3>
        <div class="scrollable-content"
          *ngIf="customer.cart?.items?.length; else noCartItems">
          <div class="cart-card" *ngFor="let item of customer.cart.items">
            <div class="flex items-start gap-3"> <!-- Smaller gap -->
              <p-avatar *ngIf="item?.productId?.thumbnail; else noImage" [image]="item?.productId?.thumbnail" shape="square" size="large"
                styleClass="flex-shrink-0"></p-avatar>
              <ng-template #noImage>
                <p-avatar shape="square" size="large" styleClass="flex-shrink-0"></p-avatar>
              </ng-template>
              <div class="flex-grow">
                <h4>{{ item.productId?.title }}</h4>
                <p>{{ commonMethod.formatCurrency(item.productId?.price) }}</p>
              </div>
            </div>
            <div class="mt-3" *ngIf="item.invoiceIds?.length"> <!-- Smaller margin -->
              <div class="text-xs grid font-medium mb-1">
                <span>Invoice</span><span>Date</span><span>Status</span><span class="text-right">Amount</span>
              </div>
              <div class="text-xs grid text-purple-700" *ngFor="let invoice of item.invoiceIds">
                <span>{{ invoice.invoiceNumber }}</span>
                <span>{{ invoice.invoiceDate | date:'dd MMM yy' }}</span>
                <p-tag [value]="invoice.status" [severity]="getStatusSeverity(invoice.status)" [rounded]="true"
                  styleClass="text-xs"></p-tag>
                <span class="text-right">{{ commonMethod.formatCurrency(invoice.totalAmount) }}</span>
              </div>
            </div>
          </div>
        </div>
        <ng-template #noCartItems>
          <div class="empty-state">
            <i class="pi pi-shopping-cart"></i>
            <h3>Empty Cart</h3>
            <p>No items added yet.</p>
          </div>
        </ng-template>
      </div>

      <!-- Payment History -->
      <div class="data-container">
        <h3>
          <i class="pi pi-wallet"></i> Payment History
          <p-badge [value]="customer.paymentHistory?.length || 0" severity="info" class="ml-2" />
        </h3>
        <div class="scrollable-content"
          *ngIf="customer.paymentHistory?.length; else noPayments">
          <p-timeline [value]="customer.paymentHistory" layout="vertical" align="left" class="payment-timeline">
            <ng-template pTemplate="marker" let-payment>
              <div class="timeline-marker" [ngClass]="'marker-' + getStatusSeverity(payment.status)">
                <i class="pi text-xs text-white" [ngClass]="{
                  'pi-check': payment.status === 'completed',
                  'pi-arrow-right-arrow-left': payment.status === 'refunded',
                  'pi-clock': payment.status === 'pending',
                  'pi-times': payment.status === 'failed'
                }"></i>
              </div>
            </ng-template>
            <ng-template pTemplate="content" let-payment>
              <div class="payment-card">
                <div class="flex mb-1"> <!-- Smaller margin -->
                  <span>{{ commonMethod.formatCurrency(payment.amount) }}</span>
                  <p-tag [value]="payment.status" [severity]="getStatusSeverity(payment.status)" [rounded]="true"
                    class="text-sm"></p-tag>
                </div>
                <p>{{ payment.createdAt | date:'dd MMM yyyy' }}</p>
                <p class="text-xs">Transaction ID: {{ payment.transactionId }}</p>
              </div>
            </ng-template>
          </p-timeline>
        </div>
        <ng-template #noPayments>
          <div class="empty-state">
            <i class="pi pi-wallet"></i>
            <h3>No Payments</h3>
            <p>No transaction history available.</p>
          </div>
        </ng-template>
      </div>
    </section>
  </div>
</div>

<p-dialog header="Edit Profile" [(visible)]="showCustomer" [modal]="true" [style]="{width: '95vw'}">
  <app-customer-snapshot [customerID]="customerId"></app-customer-snapshot>
</p-dialog>