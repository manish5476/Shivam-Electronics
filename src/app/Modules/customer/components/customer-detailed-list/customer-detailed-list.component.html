<p-toast></p-toast>

<div class="customer-dashboard">
  <!-- Header Section -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-title">
        <h1 class="breadcrumb">
          <span>Customers</span>
          <i class="pi pi-chevron-right mx-2 text-gray-400"></i>
          <span class="current-customer">{{ customer.fullname }}</span>
        </h1>
        <p class="text-sm text-gray-500">Detailed customer profile and analytics</p>
      </div>
      <div class="header-actions">
        <p-select appendTo="body" [(ngModel)]="customerId" (onChange)="getCustomerDetail()"
          [options]="customerIDDropdown" optionLabel="fullname" optionValue="_id" placeholder="Select Customer"
          [filter]="true" filterBy="fullname" styleClass="w-48">
        </p-select>
        <p-button icon="pi pi-refresh" styleClass="p-button-text ml-2" (onClick)="getCustomerDetail()"
          pTooltip="Refresh" tooltipPosition="bottom"></p-button>
        <p-button icon="pi pi-pencil" styleClass="p-button-text ml-2" (click)="showCustomer=true" pTooltip="Edit"
          tooltipPosition="bottom"></p-button>
      </div>
    </div>
  </header>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container grid grid-cols-1 md:grid-cols-3 gap-4">
    <p-skeleton height="12rem" styleClass="rounded-xl"></p-skeleton>
    <p-skeleton height="12rem" styleClass="rounded-xl"></p-skeleton>
    <p-skeleton height="12rem" styleClass="rounded-xl"></p-skeleton>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && customer" class="dashboard-content">
    <!-- Profile Hero -->
    <section class="profile-hero grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- Profile Info -->
      <div class="profile-card col-span-1 bg-white rounded-xl shadow-sm p-4">
        <div class="flex items-center gap-4">
          <p-avatar [image]="customer?.profileImg" shape="circle" size="xlarge" styleClass="flex-shrink-0"></p-avatar>
          <div class="flex-grow">
            <h2 class="text-xl font-semibold">{{ customer.fullname }}</h2>
            <p class="text-sm text-gray-600">{{ customer.email }}</p>
            <p-tag [value]="customer.status" [severity]="getStatusSeverity(customer.status)" class="mt-2"
              [rounded]="true"></p-tag>
          </div>
        </div>
      </div>

      <!-- Financial Overview -->
      <div class="financial-card col-span-1 md:col-span-2 bg-white rounded-xl shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <i class="pi pi-chart-line text-blue-500"></i> Financial Summary
        </h3>
        <div class="grid grid-cols-2 gap-4">
          <div class="kpi-item">
            <span class="text-sm text-gray-500">Total Revenue</span>
            <div class="text-xl font-bold text-green-600">{{ commonMethod.formatCurrency(customer.totalPurchasedAmount)
              }}</div>
          </div>
          <div class="kpi-item">
            <span class="text-sm text-gray-500">Outstanding</span>
            <div class="text-xl font-bold"
              [ngClass]="{'text-red-600': getTotalUnpaidAmount() > 0, 'text-gray-500': getTotalUnpaidAmount() === 0}">
              {{ commonMethod.formatCurrency(getTotalUnpaidAmount()) }}
            </div>
          </div>
        </div>
        <div class="mt-4">
          <span class="text-sm text-gray-500">Payment Success Rate</span>
          <p-progressBar [value]="getPaymentSuccessRate()" mode="determinate" [showValue]="false"
            class="h-2 mt-1"></p-progressBar>
          <span class="text-right block text-sm font-medium mt-1">{{ getPaymentSuccessRate() }}%</span>
        </div>
      </div>
    </section>

    <!-- Overview Section -->
    <section class="overview-section mb-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <i class="pi pi-info-circle text-purple-600"></i> Overview
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Contact Info -->
        <div class="bg-white rounded-xl shadow-sm p-4">
          <h3 class="text-base font-semibold mb-3 flex items-center gap-2">
            <i class="pi pi-id-card text-green-500"></i> Contact Details
          </h3>
          <dl class="text-sm space-y-2">
            <div class="flex justify-between">
              <dt class="text-gray-500">Email</dt>
              <dd class="font-medium">{{ customer.email }}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-500">Mobile</dt>
              <dd class="font-medium">{{ customer.mobileNumber || 'N/A' }}</dd>
            </div>
            <div class="flex justify-between" *ngIf="customer.phoneNumbers?.length">
              <dt class="text-gray-500">Alt Phone</dt>
              <dd class="font-medium">{{ customer.phoneNumbers[0].number }}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-500">Since</dt>
              <dd class="font-medium">{{ customer.createdAt | date:'MMM dd, yyyy' }}</dd>
            </div>
          </dl>
        </div>

        <!-- Address -->
        <div class="bg-white rounded-xl shadow-sm p-4" *ngIf="customer.addresses?.length">
          <h3 class="text-base font-semibold mb-3 flex items-center gap-2">
            <i class="pi pi-map-marker text-orange-500"></i> Primary Address
          </h3>
          <p class="text-sm">
            {{ customer.addresses[0].street }}<br>
            {{ customer.addresses[0].city }}, {{ customer.addresses[0].state }} {{ customer.addresses[0].zipCode }}<br>
            {{ customer.addresses[0].country }}
          </p>
          <p-chip [label]="customer.addresses[0].type" styleClass="mt-2"></p-chip>
        </div>
      </div>
    </section>

    <!-- Cart and Payment Section - Two Columns in One Row -->
    <section class="cart-payment-section mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Cart Items -->
      <div class="data-container bg-white rounded-xl shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-3 flex items-center gap-2 text-purple-700">
          <i class="pi pi-shopping-bag"></i> Cart Items
          <p-badge [value]="customer.cart?.items?.length || 0" severity="info" class="ml-2" />
        </h3>
        <div class="scrollable-content max-h-96 overflow-y-auto pr-2"
          *ngIf="customer.cart?.items?.length; else noCartItems">
          <div class="cart-card bg-purple-50 rounded-xl shadow-sm p-4 border border-purple-100 mb-4"
            *ngFor="let item of customer.cart.items">
            <div class="flex items-start gap-4">
              <p-avatar [image]="item?.productId?.thumbnail" shape="square" size="large"
                styleClass="flex-shrink-0"></p-avatar>
              <div class="flex-grow">
                <h4 class="text-base font-semibold text-purple-800">{{ item.productId?.title }}</h4>
                <p class="text-sm text-purple-600">{{ commonMethod.formatCurrency(item.productId?.price) }}</p>
              </div>
            </div>
            <div class="mt-4" *ngIf="item.invoiceIds?.length">
              <div class="text-xs grid grid-cols-4 gap-2 font-medium text-purple-500 mb-1">
                <span>Invoice</span><span>Date</span><span>Status</span><span class="text-right">Amount</span>
              </div>
              <div class="text-xs grid grid-cols-4 gap-2 text-purple-700" *ngFor="let invoice of item.invoiceIds">
                <span>{{ invoice.invoiceNumber }}</span>
                <span>{{ invoice.invoiceDate | date:'dd MMM yy' }}</span>
                <p-tag [value]="invoice.status" [severity]="getStatusSeverity(invoice.status)" [rounded]="true"
                  styleClass="text-xs"></p-tag>
                <span class="text-right">{{ commonMethod.formatCurrency(invoice.totalAmount) }}</span>
              </div>
            </div>
          </div>
        </div>
        <ng-template #noCartItems>
          <div class="empty-state text-center py-8 bg-white rounded-xl shadow-sm">
            <i class="pi pi-shopping-cart text-5xl text-purple-400 mb-4"></i>
            <h3 class="text-lg font-medium text-purple-800">Empty Cart</h3>
            <p class="text-sm text-purple-600">No items added yet.</p>
          </div>
        </ng-template>
      </div>

      <!-- Payment History -->
      <div class="data-container bg-white rounded-xl shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-3 flex items-center gap-2 text-purple-700">
          <i class="pi pi-wallet"></i> Payment History
          <p-badge [value]="customer.paymentHistory?.length || 0" severity="info" class="ml-2" />
        </h3>
        <div class="scrollable-content max-h-96 overflow-y-auto pr-2"
          *ngIf="customer.paymentHistory?.length; else noPayments">
          <p-timeline [value]="customer.paymentHistory" layout="vertical" align="left" class="payment-timeline">
            <ng-template pTemplate="marker" let-payment>
              <div class="timeline-marker rounded-full w-4 h-4 flex items-center justify-center"
                [ngClass]="'marker-' + getStatusSeverity(payment.status)">
                <i class="pi text-xs text-white" [ngClass]="{
                  'pi-check': payment.status === 'completed',
                  'pi-arrow-right-arrow-left': payment.status === 'refunded',
                  'pi-clock': payment.status === 'pending',
                  'pi-times': payment.status === 'failed'
                }"></i>
              </div>
            </ng-template>
            <ng-template pTemplate="content" let-payment>
              <div class="payment-card bg-purple-50 rounded-lg p-3 shadow-sm border border-purple-100 ml-6">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold text-purple-800">{{ commonMethod.formatCurrency(payment.amount) }}</span>
                  <p-tag [value]="payment.status" [severity]="getStatusSeverity(payment.status)" [rounded]="true"
                    class="text-sm"></p-tag>
                </div>
                <p class="text-sm text-purple-700 mb-1">{{ payment.createdAt | date:'dd MMM yyyy' }}</p>
                <p class="text-xs text-purple-600">Transaction ID: {{ payment.transactionId }}</p>
              </div>
            </ng-template>
          </p-timeline>
        </div>
        <ng-template #noPayments>
          <div class="empty-state text-center py-8 bg-white rounded-xl shadow-sm">
            <i class="pi pi-wallet text-5xl text-purple-400 mb-4"></i>
            <h3 class="text-lg font-medium text-purple-800">No Payments</h3>
            <p class="text-sm text-purple-600">No transaction history available.</p>
          </div>
        </ng-template>
      </div>
    </section>
  </div>
</div>

<p-dialog header="Edit Profile" [(visible)]="showCustomer" [modal]="true" [style]="{width: '95vw'}">
  <app-customer-snapshot [customerID]="customerId"></app-customer-snapshot>
</p-dialog>

<!-- <div class="customer-dashboard w-full">
  <p-toast></p-toast>

  Header Section
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-title">
        <h1 class="breadcrumb"><span>Customer List</span> > <span class="current-customer">{{ customer.fullname
            }}</span></h1>
        <p>Comprehensive customer overview and analytics</p>
      </div>
      <div class="header-actions">
        <p-select appendTo="body" [(ngModel)]="customerId" (onChange)="getCustomerDetail()"
          [options]="customerIDDropdown" optionLabel="fullname" optionValue="_id" placeholder="Select a Customer"
          [filter]="true" filterBy="fullname" styleClass="filter-input filter-input-lg">
        </p-select>
        <p-button icon="pi pi-refresh" label="Refresh" styleClass="p-button-outlined" (onClick)="getCustomerDetail()">
        </p-button>
        <p-button icon="pi pi-pencil" label="Edit Customer" styleClass="p-button-outlined"
          (click)="showCustomer=true"></p-button>
      </div>
    </div>
  </div>

  Loading State
  <div *ngIf="isLoading" class="loading-container">
    <p-skeleton height="200px" styleClass="mb-3"></p-skeleton>
    <p-skeleton height="300px"></p-skeleton>
  </div>

  Main Content
  <div *ngIf="!isLoading && customer" class="dashboard-content">
    <div class="profile-hero-v2">
      <div class="profile-main-v2">

        <p-avatar *ngIf="customer.profileImg" [image]="customer?.profileImg" shape="square"
          styleClass="profile-avatar-v2"></p-avatar>
        <p-avatar *ngIf="!customer.profileImg" [image]="customer?.profileImg" [label]="getInitials(customer.fullname)"
          shape="circle" styleClass="profile-avatar-v2"></p-avatar>
        <div class="profile-info">
          <h2 class="customer-name">{{ customer.fullname }}</h2>
          <p class="customer-email">{{ customer.email }}</p>
          <p-tag [value]="customer.status" [severity]="getStatusSeverity(customer.status)"
            styleClass="status-badge"></p-tag>
        </div>
      </div>

      <div class="financial-overview-v2">
        <h3 class="card-title">
          <i class="pi pi-chart-bar"></i>
          <span>Financial Overview</span>
        </h3>

        <div class="kpi-metrics">
          <div class="kpi-card positive">
            <div class="kpi-icon"><i class="pi pi-arrow-up"></i></div>
            <div class="kpi-details">
              <span class="kpi-value">{{ commonMethod.formatCurrency(customer.totalPurchasedAmount) }}</span>
              <span class="kpi-label">Total Revenue</span>
            </div>
          </div>
          <div class="kpi-card" [ngClass]="getTotalUnpaidAmount() > 0 ? 'negative' : 'neutral'">
            <div class="kpi-icon">
              <i class="pi" [ngClass]="getTotalUnpaidAmount() > 0 ? 'pi-exclamation-triangle' : 'pi-check'"></i>
            </div>
            <div class="kpi-details">
              <span class="kpi-value">{{ commonMethod.formatCurrency(getTotalUnpaidAmount()) }}</span>
              <span class="kpi-label">Outstanding Balance</span>
            </div>
          </div>
        </div>

        <div class="payment-rate-section-v2">
          <div class="rate-header">
            <span>Payment Success Rate</span>
            <span class="rate-percentage">{{ getPaymentSuccessRate() }}%</span>
          </div>
          <p-progressBar [value]="getPaymentSuccessRate()" styleClass="payment-progress"></p-progressBar>
        </div>
      </div>

      <div class="notes-section-v2">
        <h3 class="card-title">
          <i class="pi pi-pencil"></i>
          <span>Notes</span>
        </h3>
        <div class="notes-list">
          <p>- This customer is lorem ipsum dolor sit amet</p>
          <p>- Lorem ipsum dolor sit amet</p>
          <p>- Has payment history on certain items</p>
        </div>
        <p-button label="Save note" styleClass="p-button-primary"></p-button>
      </div>

    </div>
    Customer Tabs
    <p-tabs [(value)]="activeTab" scrollable styleClass="custom-tabs">

      Tab List
      <p-tablist>
        <p-tab value="0" class="flex items-center gap-2">
          <i class="pi pi-user"></i>
          <span class="font-semibold">Overview</span>
        </p-tab>
        <p-tab value="1" class="flex items-center gap-2">
          <i class="pi pi-shopping-cart"></i>
          <span class="font-semibold">Cart Items</span>
          <p-badge *ngIf="customer.cart?.items?.length" [value]="customer.cart.items.length" />
        </p-tab>
        <p-tab value="2" class="flex items-center gap-2">
          <i class="pi pi-credit-card"></i>
          <span class="font-semibold">Payment History</span>
          <p-badge *ngIf="customer.paymentHistory?.length" [value]="customer.paymentHistory.length" />
        </p-tab>
        <p-tab value="3" class="flex items-center gap-2">
          <i class="pi pi-file"></i>
          <span class="font-semibold">Files</span>
        </p-tab>
      </p-tablist>

      Tab Panels
      <p-tabpanels>

        Overview
        <p-tabpanel value="0">
          <div class="tab-content">
            <div class="overview-grid-v2">
              Contact Information
              <div class="overview-card-v2">
                <h3 class="card-title"><i class="pi pi-phone"></i> Contact Information</h3>
                <ul class="overview-list">
                  <li class="overview-list-item">
                    <div class="item-content">
                      <span class="item-label">Email Address</span>
                      <span class="item-value">{{ customer.email }}</span>
                    </div>
                    <div class="item-actions">
                      <button pButton icon="pi pi-copy" class="p-button-text p-button-rounded"
                        pTooltip="Copy Email"></button>
                      <button pButton icon="pi pi-envelope" class="p-button-text p-button-rounded"
                        pTooltip="Send Email"></button>
                    </div>
                  </li>
                  <li class="overview-list-item">
                    <div class="item-content">
                      <span class="item-label">Mobile Number</span>
                      <span class="item-value">{{ customer.mobileNumber || 'N/A' }}</span>
                    </div>
                    <div class="item-actions">
                      <button pButton icon="pi pi-copy" class="p-button-text p-button-rounded"
                        pTooltip="Copy Number"></button>
                    </div>
                  </li>
                  <li class="overview-list-item" *ngIf="customer.phoneNumbers?.length">
                    <div class="item-content">
                      <span class="item-label">Additional Phone</span>
                      <span class="item-value">{{ customer.phoneNumbers[0].number }}</span>
                    </div>
                    <div class="item-actions">
                      <button pButton icon="pi pi-copy" class="p-button-text p-button-rounded"
                        pTooltip="Copy Number"></button>
                    </div>
                  </li>
                  <li class="overview-list-item">
                    <div class="item-content">
                      <span class="item-label">Customer Since</span>
                      <span class="item-value">{{ customer.createdAt | date:'longDate' }}</span>
                    </div>
                  </li>
                </ul>
              </div>

              Address
              <div class="overview-card-v2" *ngIf="customer.addresses?.length">
                <h3 class="card-title"><i class="pi pi-map-marker"></i> Primary Address</h3>
                <div class="address-container">
                  <div class="address-visual"><i class="pi pi-map"></i></div>
                  <div class="address-details">
                    <p class="address-text">
                      <strong>{{ customer.addresses[0].street }}</strong><br>
                      {{ customer.addresses[0].city }}, {{ customer.addresses[0].state }}<br>
                      {{ customer.addresses[0].zipCode }}, {{ customer.addresses[0].country }}
                    </p>
                    <p-chip [label]="customer.addresses[0].type" icon="pi pi-home"
                      styleClass="address-type-chip"></p-chip>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </p-tabpanel>

        Cart Items
        <p-tabpanel value="1">
          <div class="tab-content">
            <div class="items-grid-container" *ngIf="customer.cart?.items?.length; else noItems">
              <div class="item-card-v2" *ngFor="let item of customer.cart.items">
                <div class="item-card-header">
                  <p-avatar class="item-visual" [image]="item?.productId?.thumbnail" shape="square"
                    styleClass="product-avatar-large">
                  </p-avatar>
                  <div ><i class="pi pi-box product-icon"></i></div>
                  <div class="item-details">
                    <h4 class="item-title">{{ item.productId?.title }}</h4>
                  </div>
                  <div class="item-price">
                    <span class="price-label">Price</span>
                    <span class="price-value">{{ commonMethod.formatCurrency(item.productId?.price) }}</span>
                  </div>
                </div>

                <div class="item-card-invoices" *ngIf="item.invoiceIds?.length">
                  <div class="invoice-list-header">
                    <span>Invoice #</span><span>Date</span><span>Status</span><span class="text-right">Amount</span>
                  </div>
                  <div class="invoice-list">
                    <div class="invoice-row" *ngFor="let invoice of item.invoiceIds">
                      <div class="invoice-cell"><span class="cell-label">Invoice #</span><span>{{
                          invoice.invoiceNumber }}</span></div>
                      <div class="invoice-cell"><span class="cell-label">Date</span><span>{{ invoice.invoiceDate |
                          date:'dd-MMM-yy' }}</span></div>
                      <div class="invoice-cell"><span class="cell-label">Status</span><p-tag [value]="invoice.status"
                          [severity]="getStatusSeverity(invoice.status)" styleClass="status-tag-compact"></p-tag>
                      </div>
                      <div class="invoice-cell text-right"><span class="cell-label">Amount</span><span>{{
                          commonMethod.formatCurrency(invoice.totalAmount) }}</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <ng-template #noItems>
              <div class="empty-state">
                <i class="pi pi-shopping-cart empty-icon"></i>
                <h3>No Items in Cart</h3>
                <p>This customer hasn't added any items to their cart yet.</p>
              </div>
            </ng-template>
          </div>
        </p-tabpanel>

        Payment History
        <p-tabpanel value="2">
          <div class="tab-content">
            <div class="payments-container" *ngIf="customer.paymentHistory?.length; else noPayments">
              <p-timeline [value]="customer.paymentHistory" layout="vertical" align="left">

                <ng-template pTemplate="marker" let-payment>
                  <div class="timeline-marker-v2" [ngClass]="'marker-' + getStatusSeverity(payment.status)">
                    <i class="pi" [ngClass]="{
                  'pi-check': payment.status === 'completed',
                  'pi-arrow-right-arrow-left': payment.status === 'refunded',
                  'pi-clock': payment.status === 'pending',
                  'pi-times-circle': payment.status === 'failed'
                }"></i>
                  </div>
                </ng-template>

                <ng-template pTemplate="content" let-payment>
                  <div class="payment-card-v2" [ngClass]="'payment-' + getStatusSeverity(payment.status)">
                    <div class="payment-header-v2">
                      <div class="payment-source">
                        <i class="pi pi-credit-card payment-method-icon"></i>
                        <span class="payment-amount">{{ commonMethod.formatCurrency(payment.amount) }}</span>
                      </div>
                      <p-tag [value]="payment.status" [severity]="getStatusSeverity(payment.status)"></p-tag>
                    </div>
                    <div class="payment-details-v2">
                      <div class="payment-info"><span class="payment-label">Transaction ID</span><span
                          class="payment-value">{{ payment.transactionId }}</span></div>
                      <div class="payment-info"><span class="payment-label">Date & Time</span><span
                          class="payment-value">{{ payment.createdAt | date:'dd MMM yyyy, h:mm a' }}</span></div>
                    </div>
                  </div>
                </ng-template>

              </p-timeline>
            </div>

            <ng-template #noPayments>
              <div class="empty-state">
                <i class="pi pi-credit-card empty-icon"></i>
                <h3>No Payment History</h3>
                <p>No payment transactions found for this customer.</p>
              </div>
            </ng-template>
          </div>
        </p-tabpanel>

        Files Tab
        <p-tabpanel value="3">
          <div class="tab-content">
            <div class="files-container">
              <div class="file-header">
                <h3 class="card-title"><i class="pi pi-folder"></i> Files / Documents</h3>
                <p-button icon="pi pi-plus" label="Add Files" styleClass="p-button-outlined"></p-button>
              </div>
              <div class="file-list">
                <div class="file-row">
                  <i class="pi pi-file-pdf"></i>
                  <span>Checkup Result.pdf</span>
                  <span>122kb</span>
                  <i class="pi pi-trash"></i>
                </div>
                <div class="file-row">
                  <i class="pi pi-file-pdf"></i>
                  <span>Dental X-Ray Result 2.pdf</span>
                  <span></span>
                  <i class="pi pi-trash"></i>
                </div>
                <div class="file-row">
                  <i class="pi pi-file-pdf"></i>
                  <span>Medical Prescriptions.pdf</span>
                  <span>87kb</span>
                  <i class="pi pi-trash"></i>
                </div>
                <div class="file-row">
                  <i class="pi pi-file-pdf"></i>
                  <span>Dental X-Ray Result.pdf</span>
                  <span></span>
                  <i class="pi pi-trash"></i>
                </div>
              </div>
            </div>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>
</div>

<p-dialog header="Edit Customer" [(visible)]="showCustomer" [modal]="true" [style]="{ width: '95vw', maxWidth: '99%' }">
  <app-customer-snapshot [customerID]="customerId"></app-customer-snapshot>
</p-dialog> -->