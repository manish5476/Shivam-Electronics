<p-toast></p-toast>
<div class="page-container" *ngIf="(user$ | async) as user; else loadingTemplate">
  <div class="profile-banner glass-card">
    <div class="banner-content">
      <!-- Avatar Section -->
      <div class="avatar-section">
        <p-avatar [image]="user?.profilePhoto || 'assets/no-data.png'"
          styleClass="avatar-lg"
          size="xlarge" shape="circle">
        </p-avatar>

        <!-- Upload button -->
        <div class="upload-btn-wrapper">
          <p-fileUpload #uploader mode="basic" name="profilePhoto" [auto]="true" [customUpload]="true"
            (uploadHandler)="handleProfilePhotoUpload($event, uploader)" [disabled]="(isUploading$ | async)"
            accept="image/*" maxFileSize="2000000" chooseIcon="pi pi-camera"
            styleClass="p-button-rounded p-button-secondary upload-btn">
          </p-fileUpload>
        </div>
      </div>

      <!-- Info + Account Details -->
      <div class="info-section">
        <h1 class="profile-name">{{ user.name }}</h1>
        <p class="email-text">{{ user.email }}</p>

        <div class="meta-info">
          <p-tag [value]="user.role" [severity]="roleSeverityMap[user.role] || 'info'" styleClass="role-tag"></p-tag>
          <div class="meta-item">
            <i class="pi pi-calendar-plus"></i>
            <span>Member since {{ user.createdAt | date:'longDate' }}</span>
          </div>
        </div>

        <!-- Account Details Card -->
        <div class="account-details-card">
          <h2 class="section-title"><i class="pi pi-user-edit"></i> Account Details</h2>
          <ul class="details-list">
            <li>
              <strong>User ID:</strong>
              <span class="mono-text">{{ user._id }}</span>
            </li>
            <li>
              <strong>Last Update:</strong>
              <span>{{ user.updatedAt | date:'longDate' }}</span>
            </li>
            <li>
              <strong>Password Changed:</strong>
              <span>{{ user.passwordChangedAt ? (user.passwordChangedAt | date:'longDate') : 'Never' }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Content -->
  <div class="profile-content">
    <div class="content-grid">
      <!-- Grouped Permissions -->
      <div class="card permissions-card" *ngIf="(groupedPermissions$ | async) as grouped">
        <h2 class="section-title"><i class="pi pi-lock"></i> Allowed Permissions</h2>
        <div class="permissions-grid">
          <div class="permission-group" *ngFor="let group of grouped">
            <h3 class="group-title">{{ group.module | titlecase }}</h3>
            <div class="actions">
              <p-chip *ngFor="let action of group.actions" [label]="action" styleClass="perm-chip">
              </p-chip>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loader -->
<ng-template #loadingTemplate>
  <div class="loading-container">
    <!-- <p-progressSpinner styleClass="w-16 h-16" strokeWidth="3" fill="var(--theme-bg-primary)"></p-progressSpinner> -->
    <p class="loading-text">Loading Profile...</p>
  </div>
</ng-template>