<p-toast></p-toast>
<div class="page-container" *ngIf="(user$ | async) as user; else loadingTemplate">
  
  <div class="profile-banner">
    <div class="banner-content">
      <div class="avatar-section">
        <p-avatar 
          [image]="user.profilePhoto || 'assets/no-data.png'" 
          styleClass="w-32 h-32 text-6xl ring-4 ring-offset-4 ring-offset-[var(--theme-bg-secondary)] ring-[var(--theme-accent-secondary)]" 
          size="xlarge" 
          shape="circle">
        </p-avatar>
        <p-fileUpload #uploader mode="basic" name="profilePhoto" [auto]="true" [customUpload]="true"
          (uploadHandler)="handleProfilePhotoUpload($event, uploader)" [disabled]="(isUploading$ | async)"
          accept="image/*" maxFileSize="2000000" chooseIcon="pi pi-camera"
          styleClass="p-button-rounded p-button-secondary absolute bottom-2 right-2">
        </p-fileUpload>
      </div>
      <div class="info-section">
        <h1 class="text-[var(--theme-text-primary)]">{{ user.name }}</h1>
        <p class="text-lg text-[var(--theme-text-secondary)] mt-1">{{ user.email }}</p>
        <div class="meta-info">
          <p-tag [value]="user.role" [severity]="roleSeverityMap[user.role] || 'info'" styleClass="font-semibold"></p-tag>
          <div class="meta-item">
            <i class="pi pi-calendar-plus"></i>
            <span>Member since {{ user.createdAt | date:'longDate' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="profile-content">
    <div class="content-grid">
      <div class="card">
        <h2 class="section-title"><i class="pi pi-user-edit"></i>Account Details</h2>
        <ul class="details-list">
          <li><strong>User ID:</strong><span>{{ user._id }}</span></li>
          <li><strong>Last Update:</strong><span>{{ user.updatedAt | date:'longDate' }}</span></li>
          <li><strong>Last Password Change:</strong><span>{{ user.passwordChangedAt ? (user.passwordChangedAt | date:'longDate') : 'Never' }}</span></li>
        </ul>
      </div>

      <div class="card permissions-card" *ngIf="(groupedPermissions$ | async) as permissions">
        <h2 class="section-title"><i class="pi pi-lock"></i>Assigned Permissions</h2>
        <div class="permissions-grid">
          <div class="permission-group" *ngFor="let group of permissions">
            <h3 class="permission-module-title">{{ group.module | titlecase }}</h3>
            <div class="permissions-list">
              <p-chip *ngFor="let action of group.actions" [label]="action" styleClass="text-xs"></p-chip>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<ng-template #loadingTemplate>
  <div class="loading-container">
    <i class="pi pi-spin pi-spinner text-4xl text-[var(--theme-accent-primary)]"></i>
  </div>
</ng-template>