<div *ngIf="data; else noDataOrLoading" class="payment-analytics-page">

  <header class="page-header">
    <div>
      <h1 class="page-title">Payment & Collection Analytics</h1>
      <p class="page-subtitle">A complete overview of your financial health and payment flows.</p>
    </div>
  </header>

  <div class="kpi-grid">
    <div class="summary-kpi-card">
      <div class="kpi-icon-wrapper bg-[var(--theme-success-light)]">
        <i class="pi pi-check-circle text-[var(--theme-success-primary)]"></i>
      </div>
      <div class="kpi-content">
        <span class="kpi-value">{{ data.financialHealth.totalCollected | currency:'INR':'symbol':'1.0-0' }}</span>
        <span class="kpi-label">Total Collected</span>
      </div>
    </div>
    <div class="summary-kpi-card">
      <div class="kpi-icon-wrapper bg-[var(--theme-info-light)]">
        <i class="pi pi-file-import text-[var(--theme-info-primary)]"></i>
      </div>
      <div class="kpi-content">
        <span class="kpi-value">{{ data.financialHealth.totalBilled | currency:'INR':'symbol':'1.0-0' }}</span>
        <span class="kpi-label">Total Billed</span>
      </div>
    </div>
    <div class="summary-kpi-card">
      <div class="kpi-icon-wrapper bg-[var(--theme-error-light)]">
        <i class="pi pi-times-circle text-[var(--theme-error-primary)]"></i>
      </div>
      <div class="kpi-content">
        <span class="kpi-value">{{ data.failedPayments.count }}</span>
        <span class="kpi-label">Failed Payments</span>
      </div>
    </div>
  </div>

  <div class="main-content-grid">
    <div class="se-card">
      <h3 class="card-header">Collection Trends</h3>
      <div class="chart-container large-chart">
        <ngx-charts-area-chart
            [results]="collectionTrendData"
            [scheme]="lineChartColorScheme"
            [gradient]="true"
            [xAxis]="true"
            [yAxis]="true"
            [legend]="false"
            [showXAxisLabel]="true"
            xAxisLabel="Date"
            [showYAxisLabel]="true"
            yAxisLabel="Amount Collected">
        </ngx-charts-area-chart>
      </div>
    </div>

    <div class="insight-sidebar">
      <div class="se-card">
        <h3 class="card-header">Payment Methods</h3>
        <div class="chart-container small-chart">
          <ngx-charts-pie-chart
            [results]="paymentMethodData"
            [scheme]="pieChartColorScheme"
            [doughnut]="true"
            [legend]="false"
            [labels]="true"
            [arcWidth]="0.35">
          </ngx-charts-pie-chart>
        </div>
      </div>
      <div class="se-card center-content">
        <h3 class="card-header">Collection Rate</h3>
        <div class="chart-container gauge-chart">
          <ngx-charts-gauge
            [results]="collectionRateData"
            [scheme]="gaugeColorScheme"
            [min]="0"
            [max]="120"
            [angleSpan]="180"
            [startAngle]="-90"
            [units]="'%' "
            [showAxis]="true">
          </ngx-charts-gauge>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #noDataOrLoading>
  <div class="flex justify-center items-center h-screen">
    <p class="text-xl" [style.color]="'var(--theme-text-secondary)'">
      Payment analytics are currently unavailable.
    </p>
  </div>
</ng-template>