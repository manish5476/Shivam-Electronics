<div *ngIf="data; else noDataOrLoading" class="kpi-widget-container">

  <header class="widget-header">
    <h1 class="widget-title">Business Health Overview</h1>
    <p class="widget-subtitle">A summary of core performance indicators.</p>
  </header>

  <div class="kpi-metrics-grid">
    <div class="metric-item">
      <div class="metric-icon bg-[var(--theme-success-light)] text-[var(--theme-success-primary)]">
        <i class="pi pi-wallet"></i>
      </div>
      <div class="metric-details">
        <span class="metric-label">Total Revenue</span>
        <span class="metric-value">{{ data.salesSummary.totalRevenue | currency:'INR':'symbol':'1.0-0' }}</span>
      </div>
    </div>

    <div class="metric-item">
      <div class="metric-icon bg-[var(--theme-accent-primary-light)] text-[var(--theme-accent-primary)]">
        <i class="pi pi-chart-pie"></i>
      </div>
      <div class="metric-details">
        <span class="metric-label">Gross Profit</span>
        <span class="metric-value">{{ data.salesSummary.grossProfit | currency:'INR':'symbol':'1.0-0' }}</span>
        <span class="metric-sub-value">Margin: {{ data.salesSummary.profitMargin | number:'1.1-1' }}%</span>
      </div>
    </div>

    <div class="metric-item">
      <div class="metric-icon bg-[var(--theme-info-light)] text-[var(--theme-info-primary)]">
        <i class="pi pi-shopping-cart"></i>
      </div>
      <div class="metric-details">
        <span class="metric-label">Avg. Order Value</span>
        <span class="metric-value">{{ data.salesSummary.averageOrderValue | currency:'INR':'symbol':'1.0-0' }}</span>
      </div>
    </div>

    <div class="metric-item">
      <div class="metric-icon bg-[var(--theme-warning-light)] text-[var(--theme-warning-primary)]">
        <i class="pi pi-chart-line"></i>
      </div>
      <div class="metric-details">
        <span class="metric-label">Total Sales</span>
        <span class="metric-value">{{ data.salesSummary.totalSales }}</span>
      </div>
    </div>
  </div>

  <hr class="widget-divider">

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
    <div class="lg:col-span-2 space-y-4">
      <div class="insight-group">
        <h3 class="insight-header"><i class="pi pi-users mr-2"></i>Customer Insights</h3>
        <div class="insight-list">
          <div class="insight-item">
            <span class="insight-label">New Customers</span>
            <span class="insight-value">{{ data.customerInsights.newCustomers }}</span>
          </div>
          <div class="insight-item">
            <span class="insight-label">Customers with Dues</span>
            <span class="insight-value" [class.text-[var(--theme-error-primary)]]="data.customerInsights.customersWithDues.length > 0">
              {{ data.customerInsights.customersWithDues.length > 0 ? data.customerInsights.customersWithDues.length : 'None' }}
            </span>
          </div>
        </div>
      </div>

      <div class="insight-group">
        <h3 class="insight-header"><i class="pi pi-box mr-2"></i>Inventory Overview</h3>
        <div class="insight-list">
          <div class="insight-item">
            <span class="insight-label">Total Inventory Value</span>
            <span class="insight-value">{{ data.inventoryOverview.totalInventoryValue | currency:'INR':'symbol':'1.0-0' }}</span>
          </div>
          <div class="insight-item">
            <span class="insight-label">Items in Stock</span>
            <span class="insight-value">{{ data.inventoryOverview.totalItemsInStock }}</span>
          </div>
          <div class="insight-item" *ngIf="data.inventoryOverview.lowStockCount > 0">
            <span class="insight-label text-[var(--theme-warning-primary)]">Low Stock Items</span>
            <span class="insight-value text-[var(--theme-warning-primary)]">{{ data.inventoryOverview.lowStockCount }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="lg:col-span-1 flex flex-col items-center text-center p-4 rounded-lg bg-[var(--theme-bg-primary)]">
      <h3 class="insight-header"><i class="pi pi-credit-card mr-2"></i>Financial Health</h3>
      <div class="progress-circle mt-4" [style.--p]="getCollectionPercentage()">
        <div class="progress-value">{{ getCollectionPercentage() | number:'1.0-0' }}%</div>
        <span class="progress-label">Collected</span>
      </div>
      <p class="mt-2 font-bold text-lg text-[var(--theme-text-primary)]">
        {{ data.financialHealth.totalCollected | currency:'INR':'symbol':'1.0-0' }}
      </p>
      <p class="text-[var(--theme-text-secondary)]">out of {{ data.salesSummary.totalRevenue | currency:'INR':'symbol':'1.0-0' }}</p>
    </div>
  </div>
</div>

<ng-template #noDataOrLoading>
  <div class="flex justify-center items-center h-64 kpi-widget-container">
    <p class="text-base text-[var(--theme-text-secondary)]">
      KPI data is currently unavailable.
    </p>
  </div>
</ng-template>
