<p-toast position="top-right"></p-toast>

<div class="admin-dashboard min-h-screen p-4" [style]="{'background': 'var(--theme-bg-primary)'}" [@fadeIn]="true">

  <!-- ðŸ”¹ Enhanced Filter Toolbar -->
  <header
    class="se-filter-container flex flex-wrap md:flex-nowrap items-end gap-3 p-4 sticky top-0 z-20 shadow-lg backdrop-blur-md"
    [style]="{'background': 'var(--theme-glass-gradient)', 'border': '1px solid var(--theme-border-secondary)'}">
    <div class="flex flex-wrap md:flex-nowrap items-center justify-end gap-3 w-full md:ml-auto">
      <button pButton type="button" [icon]="isCalendarCollapsed ? 'pi pi-chevron-right' : 'pi pi-chevron-left'"
        class="p-button-text p-button-rounded p-button-sm" (click)="isCalendarCollapsed = !isCalendarCollapsed"
        [pTooltip]="isCalendarCollapsed ? 'Show Calendar' : 'Hide Calendar'" tooltipPosition="bottom">
      </button>
      <h2 class="text-lg font-semibold tracking-tight"
        [style]="{'color': 'var(--theme-text-primary)', 'font-family': 'var(--font-primary)'}">
        Admin Dashboard
      </h2>
      <div class="se-filter-field">
        <label>Period</label>
        <p-select appendTo="body" [options]="periodOptions" [(ngModel)]="selectedPeriod" optionLabel="label"
          optionValue="value" (onChange)="onFilterChange()"></p-select>
      </div>
      <div class="se-filter-field">
        <label>Limit</label>
        <p-select appendTo="body" [options]="limitOptions" [(ngModel)]="dataLimit" optionLabel="label"
          optionValue="value" (onChange)="onFilterChange()"></p-select>
      </div>
      <div *ngIf="selectedPeriod === 'custom'" class="flex items-center gap-2">
        <p-calendar [(ngModel)]="customDateRange" selectionMode="range" [readonlyInput]="true"
          placeholder="Select Date Range" dateFormat="dd/mm/yy"
          styleClass="p-inputtext-sm w-56 rounded-full"></p-calendar>
        <button pButton type="button" label="Apply" icon="pi pi-check" class="p-button-sm rounded-full"
          (click)="onApplyCustomRange()"></button>
      </div>
      <button pButton type="button" icon="pi pi-refresh" class="p-button-text p-button-rounded p-button-sm"
        (click)="triggerRefresh()" pTooltip="Refresh Data" tooltipPosition="bottom"></button>
    </div>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
    <div *ngIf="!isCalendarCollapsed" class="lg:col-span-1 lg:sticky top-20 h-full">
      <div class="dashboard-card-wrapper h-full">
        <app-notification-calendar></app-notification-calendar>
      </div>
    </div>

    <!-- Main Tabs -->
    <div class="flex flex-col gap-4"
      [ngClass]="{'lg:col-span-2': !isCalendarCollapsed, 'lg:col-span-3': isCalendarCollapsed}">
      <p-tabs orientation="left" [(value)]="activeTabValue" styleClass="dashboard-vertical-tabs">
        <p-tablist>
          <p-tab value="0">Overview</p-tab>
          <p-tab value="1">Sales & Charts</p-tab>
          <p-tab value="2">Analytics</p-tab>
          <p-tab value="3">Forecast</p-tab>
          <p-tab value="4">customer Analytics</p-tab>
        </p-tablist>
        <p-tabpanels>
          <p-tabpanel value="0">
            <div class="flex flex-col gap-4">
              <app-enhanced-kpi-summary [loading]="(isLoading$ | async) ?? false"
                [data]="(enhancedKpiSummary$ | async)?.data"></app-enhanced-kpi-summary>
              <app-dashboard-overview [data]="(overview$ | async)?.data"></app-dashboard-overview>
            </div>
          </p-tabpanel>

          <p-tabpanel value="1">
            <div class="flex flex-col gap-4">
              <app-dashboard-chart-combo [selectedPeriod]="selectedPeriod" [startDate]="startDate"
                [endDate]="endDate"></app-dashboard-chart-combo>
              <app-sales-trends [data]="(salesTrends$ | async)?.data"></app-sales-trends>
            </div>
          </p-tabpanel>

          <p-tabpanel value="2">
            <div class="flex flex-col gap-4">
              <app-product-analytics [data]="(productAnalytics$ | async)?.data"></app-product-analytics>

            </div>
          </p-tabpanel>

          <p-tabpanel value="3">
            <div class="flex flex-col gap-4">
              <app-sales-forecast [data]="(salesForecast$ | async)?.data"></app-sales-forecast>
              <app-inventory-turnover [data]="(inventoryTurnover$ | async)?.data"></app-inventory-turnover>
            </div>
          </p-tabpanel>
          <p-tabpanel value="4">
            <div class="flex flex-col gap-4">
              <app-customer-analytics [data]="(customerAnalytics$ | async)?.data"
                  (openDetail)="openDialog($event.title, $event.data, customerDetailTemplate)"
                  ></app-customer-analytics>


<ng-template #customerDetailTemplate let-data="data">
  <div class="customer-detail-card">
    <h2>{{ data.fullname }}</h2>
    <p><strong>Email:</strong> {{ data.email }}</p>
    <p><strong>Lifetime Value:</strong> â‚¹{{ data.lifetimeValue | number }}</p>
  </div>
</ng-template>

            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </div>
  </div>

  <p-dialog [(visible)]="showDialog" [modal]="true" [style]="{ width: '90vw', maxWidth: '900px' }" [draggable]="true"
    [resizable]="true" appendTo="body" styleClass="universal-dialog">
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center w-full">
        <h3 class="font-semibold text-lg">{{ selectedTitle }}</h3>
        <button pButton icon="pi pi-times" class="p-button-rounded p-button-text" (click)="showDialog = false"></button>
      </div>
    </ng-template>

    <div class="dialog-body">
      <ng-container *ngIf="dialogTemplate; else defaultContent" [ngTemplateOutlet]="dialogTemplate"
        [ngTemplateOutletContext]="{ data: selectedData }"></ng-container>

      <ng-template #defaultContent>
        <div class="json-viewer">
          <pre>{{ selectedData | json }}</pre>
        </div>
      </ng-template>
    </div>
  </p-dialog>
</div>
