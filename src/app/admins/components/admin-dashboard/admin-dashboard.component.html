<p-toast position="top-right"></p-toast>

<div class="admin-dashboard" [@fadeIn]="true">

  <!-- ðŸ”¹ Glass Header -->
  <header class="dashboard-header glass-blur sticky top-0 z-30 flex items-center justify-between px-6 py-3 shadow-lg">
    <h1 class="text-xl font-semibold tracking-tight flex items-center gap-2 text-[var(--theme-text-heading)]">
      <i class="pi pi-shield text-[var(--theme-accent-primary)] text-lg"></i>
      Admin Control Center
    </h1>
    <button pButton icon="pi pi-user" class="p-button-rounded p-button-text p-button-sm"></button>
  </header>

  <!-- ðŸ”¹ Filter Toolbar -->
  <div class="se-filter-container mt-4 animate-fadeIn">
    <div class="flex flex-wrap md:flex-nowrap items-end gap-3 justify-between w-full">

      <div class="flex flex-wrap md:flex-nowrap gap-3 items-end">
        <div class="se-filter-field">
          <label>Period</label>
          <p-select appendTo="body" [options]="periodOptions" [(ngModel)]="selectedPeriod" optionLabel="label"
            optionValue="value" (onChange)="onFilterChange()"></p-select>
        </div>
        <div class="se-filter-field">
          <label>Limit</label>
          <p-select appendTo="body" [options]="limitOptions" [(ngModel)]="dataLimit" optionLabel="label"
            optionValue="value" (onChange)="onFilterChange()"></p-select>
        </div>
        <div *ngIf="selectedPeriod === 'custom'" class="flex items-center gap-2">
          <p-calendar [(ngModel)]="customDateRange" selectionMode="range" [readonlyInput]="true"
            placeholder="Select Range" dateFormat="dd/mm/yy"
            styleClass="p-inputtext-sm w-56 rounded-full glass-input"></p-calendar>
          <button pButton type="button" label="Apply" icon="pi pi-check" class="p-button-sm rounded-full"
            (click)="onApplyCustomRange()"></button>
        </div>
      </div>

      <div class="flex gap-2 items-center">
        <button pButton type="button" icon="pi pi-refresh" class="p-button-text p-button-rounded p-button-sm"
          (click)="triggerRefresh()" pTooltip="Refresh Data" tooltipPosition="bottom"></button>
        <button pButton type="button" [icon]="isCalendarCollapsed ? 'pi pi-chevron-right' : 'pi pi-chevron-left'"
          class="p-button-text p-button-rounded p-button-sm" (click)="isCalendarCollapsed = !isCalendarCollapsed"
          [pTooltip]="isCalendarCollapsed ? 'Show Calendar' : 'Hide Calendar'" tooltipPosition="bottom"></button>
      </div>
    </div>
  </div>

  <!-- ðŸ”¹ Grid Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6 animate-fadeUp">

    <!-- ðŸ“… Sticky Calendar -->
    <div *ngIf="!isCalendarCollapsed" class="lg:col-span-1 lg:sticky top-24 h-full">
      <div class="dashboard-card-wrapper h-full animate-fadeIn">
        <app-notification-calendar></app-notification-calendar>
      </div>
    </div>

    <!-- ðŸ“Š Main Tabs -->
    <div class="dashboard-right-pane"
      [ngClass]="{'lg:col-span-2': !isCalendarCollapsed, 'lg:col-span-3': isCalendarCollapsed}">
      <div class="dashboard-scroll-area">
        <p-tabs [scrollable]="true" orientation="left" [(value)]="activeTabValue"
          styleClass="dashboard-vertical-tabs enhanced-tabs">
          <p-tablist>
            <p-tab value="0"><i class="pi pi-chart-bar mr-2"></i>Overview</p-tab>
            <p-tab value="1"><i class="pi pi-chart-line mr-2"></i>Sales & Charts</p-tab>
            <p-tab value="2"><i class="pi pi-database mr-2"></i>Analytics</p-tab>
            <p-tab value="3"><i class="pi pi-bolt mr-2"></i>Forecast</p-tab>
            <p-tab value="4"><i class="pi pi-users mr-2"></i>Customer Analytics</p-tab>
            <p-tab value="5"><i class="pi pi-money mr-2"></i>Payment Analytics</p-tab>
            <p-tab value="6"><i class="pi pi-money mr-2"></i>sales Analytics</p-tab>
            <p-tab value="7"><i class="pi pi-money mr-2"></i>yearly sales Analytics</p-tab>
          </p-tablist>

          <p-tabpanels>
            <p-tabpanel value="0">
              <app-enhanced-kpi-summary [loading]="(isLoading$ | async) ?? false"
                [data]="(enhancedKpiSummary$ | async)?.data"></app-enhanced-kpi-summary>
              <div class="pt-4">

                <app-dashboard-overview [data]="(overview$ | async)?.data"></app-dashboard-overview>
              </div>
            </p-tabpanel>

            <p-tabpanel value="1">
              <app-dashboard-chart-combo [selectedPeriod]="selectedPeriod" [startDate]="startDate"
                [endDate]="endDate"></app-dashboard-chart-combo>
              <!-- <app-sales-trends [data]="(salesTrends$ | async)?.data"></app-sales-trends> -->
            </p-tabpanel>

            <p-tabpanel value="2">
              <app-product-analytics [data]="(productAnalytics$ | async)?.data"></app-product-analytics>
            </p-tabpanel>

            <p-tabpanel value="3">
              <app-sales-forecast [data]="(salesForecast$ | async)?.data"></app-sales-forecast>
              <!-- <app-inventory-turnover [data]="(inventoryTurnover$ | async)?.data"></app-inventory-turnover> -->
            </p-tabpanel>

            <p-tabpanel value="4">
              <app-customer-analytics [data]="(customerAnalytics$ | async)?.data"
                (openDetail)="openDialog($event.title, $event.data, customerDetailTemplate)">
              </app-customer-analytics>

              <ng-template #customerDetailTemplate let-data="data">
                <div class="customer-detail-card glass-card">
                  <h2>{{ data.fullname }}</h2>
                  <p><strong>Email:</strong> {{ data.email }}</p>
                  <p><strong>Lifetime Value:</strong> â‚¹{{ data.lifetimeValue | number }}</p>
                </div>
              </ng-template>
            </p-tabpanel>


            <p-tabpanel value="5">
              <app-payment-analytics [data]="(paymentAnalytics$ | async)?.data"></app-payment-analytics>
            </p-tabpanel>

            <p-tabpanel value="6">
              <app-sales-charts [data]="(inventoryTurnover$ | async)?.data"></app-sales-charts>
            </p-tabpanel>

            <p-tabpanel value="7">
              <app-yearly-sales [data]="(yearlySales$ | async)?.data"></app-yearly-sales>
            </p-tabpanel>

            <p-tabpanel value="8">

              <app-inventory-turnover [data]="(inventoryTurnover$ | async)?.data"></app-inventory-turnover>
            </p-tabpanel>

          </p-tabpanels>
        </p-tabs>
      </div>
    </div>

    <!-- ðŸ”¹ Universal Dialog -->
    <p-dialog [(visible)]="showDialog" [modal]="true" appendTo="body" [style]="{ width: '90vw', maxWidth: '900px' }"
      styleClass="universal-dialog glass-dialog animate-fadeIn">
      <ng-template pTemplate="header">
        <div class="flex justify-between items-center w-full">
          <h3 class="font-semibold text-lg">{{ selectedTitle }}</h3>
          <button pButton icon="pi pi-times" class="p-button-rounded p-button-text"
            (click)="showDialog = false"></button>
        </div>
      </ng-template>

      <div class="dialog-body">
        <ng-container *ngIf="dialogTemplate; else defaultContent" [ngTemplateOutlet]="dialogTemplate"
          [ngTemplateOutletContext]="{ data: selectedData }"></ng-container>

        <ng-template #defaultContent>
          <div class="json-viewer">
            <pre>{{ selectedData | json }}</pre>
          </div>
        </ng-template>
      </div>
    </p-dialog>
  </div>