<div *ngIf="data; else noDataOrLoading" class="customer-analytics-page">

  <!-- Header -->
  <header class="page-header">
    <div>
      <h1 class="page-title">Customer Analytics</h1>
      <p class="page-subtitle">Gain insights into your customer performance and retention.</p>
    </div>
  </header>

  <!-- KPI Cards -->
  <section class="kpi-section">
    <div class="kpi-card" *ngFor="let kpi of [
      { label: 'New Customers', value: data.summary.newCustomers, icon: 'pi-user-plus', color: '--theme-success-primary', bg: '--theme-success-light' },
      { label: 'Repeat Rate', value: (data.summary.repeatCustomerRate | percent:'1.1-1'), icon: 'pi-sync', color: '--theme-accent-primary', bg: '--theme-accent-primary-light' }
    ]">
      <div class="kpi-icon" [ngStyle]="{'background-color': 'var(' + kpi.bg + ')'}">
        <i class="pi" [ngClass]="kpi.icon" [ngStyle]="{'color': 'var(' + kpi.color + ')'}"></i>
      </div>
      <div class="kpi-details">
        <span class="kpi-value">{{ kpi.value }}</span>
        <span class="kpi-label">{{ kpi.label }}</span>
      </div>
    </div>
  </section>

  <!-- Main Grid -->
  <section class="analytics-grid">
    <!-- Table -->
    <div class="se-card analytics-card">
      <h3 class="card-header">Top Customers by Lifetime Value</h3>
      <div class="table-container">
        <p-table [value]="data.topCustomersLifetime" styleClass="se-table">
          <ng-template pTemplate="header">
            <tr>
              <th>#</th>
              <th>Customer</th>
              <th>Lifetime Value</th>
              <th></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-customer let-i="rowIndex">
            <tr>
              <td><span class="rank-badge" [ngClass]="'rank-' + (i + 1)">{{ i + 1 }}</span></td>
              <td><span class="customer-name">{{ customer.fullname }}</span></td>
              <td><span class="customer-value">{{ customer.lifetimeValue | currency:'INR':'symbol':'1.0-0' }}</span></td>
              <td>
                <button pButton type="button" label="View" icon="pi pi-arrow-right"
                        class="p-button-text p-button-sm"
                        (click)="viewCustomerDetails(customer)"></button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <!-- Sidebar Chart -->
    <div class="se-card analytics-card chart-card">
      <h3 class="card-header">Repeat Customer Rate</h3>
      <div class="chart-wrapper">
        <ngx-charts-pie-chart
          [results]="repeatRateChartData"
          [scheme]="chartColorScheme"
          [doughnut]="true"
          [legend]="false"
          [labels]="true"
          [arcWidth]="0.3">
        </ngx-charts-pie-chart>
      </div>
    </div>
  </section>
</div>

<ng-template #noDataOrLoading>
  <div class="no-data">
    <p>Customer analytics are currently unavailable.</p>
  </div>
</ng-template>

